{% extends 'baseDashboardUsuario.html' %} {% load static %} {% load humanize %}
{% block dashboard_content %}
{% include 'notificaciones/modalNotificacion.html' %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<div class="dashboard-grid">
  <!-- COLUMNA IZQUIERDA -->
  <div class="col-left">
    <div class="bloque-izquierdo">
      <!-- Indicadores principales -->
      <section class="indicadores">
        <div class="indicador-card">
          <div class="indicador-icon">
            <i class="icon">üìä</i>
          </div>
          <div class="indicador-content">
            <span class="numero">15</span>
            <span class="label">Transacciones totales</span>
            <div class="trend-indicator up">+8.2%</div>
          </div>
        </div>
        <div class="indicador-card">
          <div class="indicador-icon">
            <i class="icon">üí∞</i>
          </div>
          <div class="indicador-content">
            <span class="numero">1,350 USD</span>
            <span class="label">Ganancia estimada</span>
            <div class="trend-indicator up">+15.3%</div>
          </div>
        </div>
        <div class="indicador-card">
          <div class="indicador-icon">
            <i class="icon">‚ö°</i>
          </div>
          <div class="indicador-content">
            <span class="numero">Venta</span>
            <span class="label">√öltima operaci√≥n</span>
            <div class="trend-indicator neutral">2 min ago</div>
          </div>
        </div>
      </section>

      <!-- Estad√≠sticas r√°pidas -->
      <section class="estadisticas-rapidas">
        {% include 'operaciones/limites_operaciones.html' %}
      </section>

      <!-- Conversor -->
      <main class="conversor-container">
        <h2 class="title">üí± Conversor de Divisas</h2>
        <form
          id="form-conversor"
          method="post"
          class="conversor-form"
          action="{% url 'operaciones' %}"
        >
          {% csrf_token %}

          <div class="campo fila operacion-toggle">
            <!-- Nota: mantuve los values igual que ten√≠as para no romper la l√≥gica previa:
                 value="venta" corresponde a "Compra (entrego PYG)" en tu UI original -->
            <label class="toggle-label">
              <input type="radio" name="operacion" value="venta" checked />
              Compra (entrego PYG)
            </label>
            <label class="toggle-label">
              <input type="radio" name="operacion" value="compra" /> Venta
              (recibo PYG)
            </label>
          </div>

          <!-- ==== COMPRA (se muestra cuando radio value === "venta") ==== -->
          <!-- ==== COMPRA 1: ORIGEN PYG ==== -->
<!-- ==== COMPRA ==== -->
<div class="campo fila" id="compra-1">
    <div class="input-icon-wrapper">
        <span class="icono">üíµ</span>

        {% if monedas %}
            <select id="origen-compra" name="origen" class="input-select">
                {% for moneda in monedas %}
                    {% if moneda.abreviacion == "PYG" %}
                        <option value="{{ moneda.abreviacion }}" {% if moneda.abreviacion == origen %}selected{% endif %}>
                            {{ moneda.nombre }} ({{ moneda.abreviacion }})
                        </option>
                    {% endif %}
                {% endfor %}
            </select>
        {% else %}
            <select class="input-select" disabled>
                <option selected>No hay monedas disponibles</option>
            </select>
        {% endif %}
    </div>

    <input type="text" id="valor-compra" name="valor" class="input-text" placeholder="Monto" />
</div>

<div class="campo fila" id="compra-2">
    <div class="input-icon-wrapper">
        <span class="icono">üí≤</span>

        {% if monedas %}
            <select id="destino-compra" name="destino" class="input-select">
                {% for moneda in monedas %}
                    {% if moneda.abreviacion != "PYG" %}
                        <option value="{{ moneda.abreviacion }}" {% if moneda.abreviacion == destino %}selected{% endif %}>
                            {{ moneda.nombre }} ({{ moneda.abreviacion }})
                        </option>
                        
                    {% endif %}
                {% endfor %}
            </select>
        {% else %}
            <select class="input-select" disabled>
                <option selected>No hay monedas disponibles</option>
            </select>
        {% endif %}
    </div>

    <input type="text" id="resultado-compra" name="resultado" class="input-text readonly"
        placeholder="Resultado" readonly value="{{ resultado }}" />
</div>

<!-- ==== VENTA ==== -->
<div class="campo fila" id="venta-1" style="display: none">
    <div class="input-icon-wrapper">
        <span class="icono">üíµ</span>

        {% if monedas %}
            <select id="origen-venta" name="origen" class="input-select">
                {% for moneda in monedas %}
                    {% if moneda.abreviacion != "PYG" %}
                        <option value="{{ moneda.abreviacion }}" {% if moneda.abreviacion == origen %}selected{% endif %}>
                            {{ moneda.nombre }} ({{ moneda.abreviacion }})
                        </option>
                    {% endif %}
                {% endfor %}
            </select>
        {% else %}
            <select class="input-select" disabled>
                <option selected>No hay monedas disponibles</option>
            </select>
        {% endif %}
    </div>

    <input type="text" id="valor-venta" name="valor" class="input-text" placeholder="Monto" />
</div>

<div class="campo fila" id="venta-2" style="display: none">
    <div class="input-icon-wrapper">
        <span class="icono">üí≤</span>

        {% if monedas %}
            <select id="destino-venta" name="destino" class="input-select">
                {% for moneda in monedas %}
                    {% if moneda.abreviacion == "PYG" %}
                        <option value="{{ moneda.abreviacion }}" {% if moneda.abreviacion == destino %}selected{% endif %}>
                            {{ moneda.nombre }} ({{ moneda.abreviacion }})
                        </option>
                    {% endif %}
                {% endfor %}
            </select>
        {% else %}
            <select class="input-select" disabled>
                <option selected>No hay monedas disponibles</option>
            </select>
        {% endif %}
    </div>

    <input type="text" id="resultado-venta" name="resultado" class="input-text readonly"
        placeholder="Resultado" readonly value="{{ resultado }}" />
</div>

          <button type="submit" id="btn-convertir" class="btn-convertir">
            Realizar transacci√≥n
          </button>
        </form>
      </main>
    </div>
  </div>

  <!-- COLUMNA DERECHA -->
  <div class="col-right">
    {% include 'notificaciones/modalNotificacion.html' %}
    <section class="transacciones-container">
      <h2 class="title">üßæ Transacciones Recientes</h2>
      <div class="filtro-transacciones">
        <select id="filtro-columna" class="input-select">
          <option value="fecha">Fecha</option>
          <option value="monto">Monto</option>
          <option value="moneda">Moneda</option>
          <option value="estado">Estado</option>
          <option value="tipo">Tipo</option>
        </select>
        <input
          type="text"
          id="filtro-general"
          placeholder="Buscar..."
          class="input-text"
        />
      </div>

      <table class="tabla-transacciones">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Monto</th>
            <th>Moneda</th>
            <th>Estado</th>
            <th>Tipo</th>
          </tr>
        </thead>
        <tbody>
          {% for t in transacciones %}
          <tr>
            <td>{{ t.id }}</td>
            <td>{{ t.fecha }}</td>
            <td>{{ t.monto }}</td>
            <td>{{ t.moneda_destino }}</td>
            <td>
              <span class="estado {{ t.estado|lower }}">{{ t.estado }}</span>
            </td>
            <td class="tipo-{{ t.tipo|lower }}">{{ t.tipo }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% include 'operaciones/graficoTransaccion.html' with data_transacciones_json=data_transacciones_json monedas=monedas %}
    </section>
  </div>
</div>

<!-- MODAL Mensajes -->
{% include 'operaciones/modalMensajes.html' %}

<!-- MODAL Metodo Pago -->
{% include 'operaciones/modalMetodoPago.html' %}

<!-- MODAL CONFIRMACI√ìN -->
{% include 'operaciones/modalConfirmarTransaccion.html' %}

<!-- MODAL PIN -->
{% include 'operaciones/modalPin.html' %}

<!-- MODAL √âXITO -->
{% include 'operaciones/modalExito.html' %}

<!-- MODAL MedioAcreditacion -->
{% include 'operaciones/modalMedioAcreditacion.html' %}


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
      $(document).ready(function () {

        const tasaVta = parseFloat("{{ tasa_vta|floatformat:2 }}".replace(",", "."));
        const tasaCmp = parseFloat("{{ tasa_cmp|floatformat:2 }}".replace(",", "."));

        console.log("Tasa Venta:", tasaVta, "Tasa Compra:", tasaCmp);
        console.log("resultado", "{{resultado}}");

        // Muestra/oculta inputs seg√∫n operaci√≥n
        function actualizarCamposPorOperacion() {
          const op = $("input[name='operacion']:checked").val();

          if (op === "venta") { // Venta -> "Compra por cliente (entrego PYG)"
            // mostrar compra
            $("#compra-1, #compra-2").show();
            $("#compra-1 select, #compra-1 input, #compra-2 select, #compra-2 input")
              .prop("disabled", false);

            // ocultar venta
            $("#venta-1, #venta-2").hide();
            $("#venta-1 select, #venta-1 input, #venta-2 select, #venta-2 input")
              .prop("disabled", true);

            // forzar origen PYG
            $("#origen-compra").val("PYG").prop("disabled", true);

          } else { // op === "compra" ‚Üí "Venta (recibo PYG)"
            // mostrar venta
            $("#venta-1, #venta-2").show();
            $("#venta-1 select, #venta-1 input, #venta-2 select, #venta-2 input")
              .prop("disabled", false);

            // ocultar compra
            $("#compra-1, #compra-2").hide();
            $("#compra-1 select, #compra-1 input, #compra-2 select, #compra-2 input")
              .prop("disabled", true);

            // forzar destino PYG
            $("#destino-venta").val("PYG").prop("disabled", true);
          }

          // limpiar resultados
          $("#resultado-compra, #resultado-venta").val("");
        }


        // obtener los elementos relevantes seg√∫n la operaci√≥n activa
        function getCampos() {
          const op = $("input[name='operacion']:checked").val();
          if (op === "venta") { // compra inputs activos
            return {
              $origen: $("#origen-compra"),
              $destino: $("#destino-compra"),
              $valor: $("#valor-compra"),
              $resultado: $("#resultado-compra"),
              op
            };
          } else { // venta inputs activos
            return {
              $origen: $("#origen-venta"),
              $destino: $("#destino-venta"),
              $valor: $("#valor-venta"),
              $resultado: $("#resultado-venta"),
              op
            };
          }
        }

        // c√°lculo instant√°neo
        function calcularResultado() {
          const campos = getCampos();
          if (!campos || !campos.$valor) return;

          let raw = campos.$valor.val() || "";
          raw = raw.replace(/[^0-9.]/g, '');
          const parts = raw.split('.');
          if (parts.length > 2) raw = parts.shift() + '.' + parts.join('');
          campos.$valor.val(raw);
          const monto = parseFloat(raw);
          const origenVal = campos.$origen.val();
          const destinoVal = campos.$destino.val();

          if (!monto || monto <= 0 || !origenVal || !destinoVal || origenVal === destinoVal) {
            campos.$resultado.val("");
            return;
          }

          if (!monto || monto <= 0) {
            campos.$resultado.val("");
            return;
          }
          // formateador
           //const formatter = new Intl.NumberFormat("es-ES", {
           //  minimumFractionDigits: 2,
           //  maximumFractionDigits: 2
           //});
          // AJAX para c√°lculo en el servidor (si tu endpoint responde JSON { resultado, tasa })
          $.ajax({
            url: "{% url 'operaciones' %}",
            type: "POST",
            data: {
              csrfmiddlewaretoken: "{{ csrf_token }}",
              valor: monto,
              operacion: campos.op,
              origen: origenVal,
              destino: destinoVal
            },
            success: function (resp) {
              if (resp && resp.resultado !== undefined && !isNaN(parseFloat(resp.resultado))) {
                // Caso v√°lido: backend devolvi√≥ un n√∫mero
                const resultadoNumero = parseFloat(resp.resultado);
                const resultadoFormateado = resultadoNumero; 
                campos.$resultado.val(resultadoFormateado);
                campos.$resultado.data("tasa", resp.tasa);
                campos.$resultado.data("fecha_tasa", resp.fecha_tasa);

              } else {
                // Fallback: calculo local inmediato
                let resultadoCalc = null;

                if (campos.op === "venta") {
                  if (!tasaVta || tasaVta === 0) {
                    resultadoCalc = null;
                  } else {
                    resultadoCalc = (monto / tasaVta).toFixed(2);
                  }
                } else {
                  if (!tasaCmp || tasaCmp === 0) {
                    resultadoCalc = null;
                  } else {
                    resultadoCalc = (monto * tasaCmp).toFixed(2);
                  }
                }

                if (resultadoCalc !== null) {
                  const resultadoFormateado = parseFloat(resultadoCalc);
                  campos.$resultado.val(resultadoFormateado);
                } else {
                  campos.$resultado.val("No hay cotizacion disponible");
                }
              }

              console.log("resp", resp);
            },
            error: function () {
              let resultadoCalc = campos.op === "venta"
                ? (monto / tasaVta).toFixed(2)
                : (monto * tasaCmp).toFixed(2);
                const resultadoFormateado = (parseFloat(resultadoCalc));
        campos.$resultado.val(resultadoFormateado);
            }
          });
          // c√°lculo local inmediato
            let resultadoCalc;

          if (campos.op === "venta") {
            if (!tasaVta || tasaVta === 0) {
              resultadoCalc = null; // no hay cotizaci√≥n
            } else {
              resultadoCalc = (monto / tasaVta).toFixed(2);
            }
          } else {
            if (!tasaCmp || tasaCmp === 0) {
              resultadoCalc = null; // no hay cotizaci√≥n
            } else {
              resultadoCalc = (monto * tasaCmp).toFixed(2);
            }
          }

          if (resultadoCalc !== null) {
            const resultadoFormateado = parseFloat(resultadoCalc);
            console.log("resultadoCalc formateado:", resultadoFormateado);
            campos.$resultado.val(resultadoFormateado);
          } else {
            campos.$resultado.val("No hay cotizacion disponible");
          }
        }
        // Init y eventos
        actualizarCamposPorOperacion();
        $(document).on("change", "input[name='operacion']", function () {
          actualizarCamposPorOperacion();
          calcularResultado(); // recalcular si hab√≠a valor
        });

        // inputs que deben disparar el c√°lculo
        $(document).on("input change", "#valor-compra, #valor-venta, #destino-compra, #origen-venta", function () {
          calcularResultado();
        });

        function mostrarMensaje(titulo, texto) {
          if (window.mostrarMensajeModal) {
            window.mostrarMensajeModal(titulo, texto);
          } else {
            console.error("Modal mensaje no disponible");
            alert(titulo + ": " + texto);
          }
        }

        
          function validarMonto(monto) {
            // Convertir a string
            const montoStr = monto.toString();

            // Separar parte entera y decimal
            const partes = montoStr.split(".");
            const enteros = partes[0] || "";
            const decimales = partes[1] || "";
            console.log("partes", partes);
            console.log("enteros", enteros);
            console.log("decimales", decimales);

            if (enteros.length > 15) {
                mostrarMensaje("‚ö†Ô∏è Error", "El monto no puede tener m√°s de 15 d√≠gitos antes del punto decimal.");
                return false;
            }

            if (decimales.length > 8) {
                mostrarMensaje("‚ö†Ô∏è Error", "El monto no puede tener m√°s de 8 decimales.");
                return false;
            }

            return true;
          }
          

        
          // Declaraci√≥n global
        window.fechaNavegador = null;
        var advertenciaMostrada = false; // üîë Flag para controlar el mensaje
        $(document).ready(function () {
          // Botones modales
          $("#btn-cancelar, .modal .close").click(function () {
            if (advertenciaMostrada) {
              location.reload(); // üîÑ Recargar si ya se mostr√≥ la advertencia
            } else {
              $(this).closest(".modal").fadeOut();

            }
            $(".pin-digit").val("");
          });

          // Cuando el usuario hace clic en "Realizar transacci√≥n"
          $("#btn-convertir").click(function () {
            obtenerHoraServidor(function (fechaServidor) {
              fechaNavegador = fechaServidor;
              console.log("Hora servidor usada:", fechaNavegador);
            })
          });
            

          // Bot√≥n para continuar a pesar de cambio de tasa
          $("#btn-continuar-tasa").click(function () {
            fechaNavegador = new Date(); // actualizamos fecha usada
            $("#mensaje-error-tasa").hide();
            $(this).hide();

          });

          // Nuevo bot√≥n para confirmar m√©todo de pago
          $("#btn-confirmar").click(function () {
            verificarTasaActualizada(function(tasaActualizada) {
            if (tasaActualizada) {
              //$("#modal-confirmacion").fadeOut();
              //$("#modal-metodo").fadeIn().css("display", "flex");
              console.log("Tasa actualizada, procediendo a m√©todo de pago");
            }else{
              $("#modal-exito").hide();
              mostrarMensaje("Transacci√≥n Rechazada", "‚ö†Ô∏è La tasa de cambio usada ya no es la m√°s reciente. Tiene que volver a recalcular para usar la √∫ltima tasa.");
              $("#modal-confirmacion").fadeOut();
            }
            });
          });

          $("#form-metodo-pago").submit(function(e){
            e.preventDefault();
            verificarTasaActualizada(function(tasaActualizada) {

            if (tasaActualizada) {
              $("#modal-confirmacion").fadeOut();
              $("#modal-pin").fadeIn().css("display", "flex");
            }else{
              $("#modal-exito").hide();
              mostrarMensaje("Transacci√≥n Rechazada", "‚ö†Ô∏è La tasa de cambio usada ya no es la m√°s reciente. Tiene que volver a recalcular para usar la √∫ltima tasa.");
              $("#modal-pin").fadeOut();
            }
            });
          });


        });

        function obtenerHoraServidor(callback) {
          $.get("{% url 'hora_servidor' %}", function (resp) {
            const fechaServidor = new Date(resp.hora);
            callback(fechaServidor);
          });
        }

        window.getCookie=function (name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              // Comprueba si la cookie comienza con el nombre deseado
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }

        $(".pin-digit").on("input", function () { let next = $(this).next(".pin-digit"); if (this.value.length && next.length) next.focus(); });

        const PB_MONEDA = "{{ PB_MONEDA }}";
        const tasa_recibida = "{{ tasa }}";
        window.TASA_REF_ID = "{{ TASA_REF_ID }}";

        const monedasMap = {};
        {% for moneda in monedas %}
        monedasMap["{{ moneda.abreviacion }}"] = {{ moneda.id }};
        {% endfor %}

      console.log("Mapa de monedas:", monedasMap);

      // Funci√≥n para obtener ID por abreviaci√≥n
      window.obtenerIdMoneda = function(abreviacion) {
        return monedasMap[abreviacion] || null;
      };


      // Funci√≥n reutilizable para verificar tasas
      function verificarTasaActualizada(callback) {
        const campos = getCampos();
        console.log("Verificando tasa para:", campos.$origen.val(), "->", campos.$destino.val());
        
        $.ajax({
          url: "{% url 'verificar_tasa' %}",
          type: "GET",
          data: {
            origen: campos.op == "venta" ? campos.$origen.val() : campos.$destino.val(),
            destino: campos.op == "venta" ? campos.$destino.val() : campos.$origen.val()
          },
          success: function (resp) {
            const fechaBaseDatos = new Date(resp.fecha_tasa);
            console.log("fechaNavegador:", fechaNavegador);
            console.log("fechaBaseDatos:", fechaBaseDatos);

            if (fechaBaseDatos > fechaNavegador) {
              // ‚ö†Ô∏è La tasa ya cambi√≥
              $("#btn-continuar-tasa").show();   // mostrar bot√≥n de recalcular
              $("#btn-confirmar").hide();        // ocultar bot√≥n de confirmar
              advertenciaMostrada = true;

              if (callback) callback(false); // avisar que NO puede continuar
              return;
            } else {
              if (callback) callback(true);  // tasa ok
            }
          },
          error: function() {
            console.error("Error al verificar tasa");
            if (callback) callback(true); // En caso de error, permitir continuar
          }
        });
      }

$("#btn-verificar-pin").click(function () {
  let pinIngresado = "";
  $(".pin-digit").each(function () { pinIngresado += $(this).val(); });

  if (pinIngresado === "1234") {
    // Verificar tasa antes de proceder
    verificarTasaActualizada(function(tasaActualizada) {
      console.log("Tasa actualizada:", tasaActualizada);
      if (tasaActualizada) {
        console.log("tiene que entrar")
        // ‚úÖ Proceder con la transacci√≥n
        procesarTransaccion();
      } else {
        // ‚ö†Ô∏è Cortar flujo: mostrar mensaje y bloquear confirmar
        console.log("acaaaaaaaaaaa:");
        $("#modal-exito").css("display", "none");
        mostrarMensaje(
          "Transacci√≥n rechazada",
          "‚ö†Ô∏è La tasa de cambio usada ya no es la m√°s reciente. Tiene que volver a recalcular para usar la √∫ltima tasa."
        ,"warning" ,true);
        //$("#modal-exito").hide();
        $("#modal-pin").fadeOut();
        return; // üö® corte definitivo
      }
    });
  } else {
    console.log("PIN incorrecto:", pinIngresado);
    $("#mensaje-pin").fadeIn();
    $(".pin-digit").val("").first().focus();
  }

  // limpiar inputs del PIN
  $(".pin-digit").val("");
});



// Funci√≥n separada para procesar la transacci√≥n
function procesarTransaccion() {
  console.log("Procesando transacci√≥n...");

  const campos = getCampos();
  const origenAbrev = campos.$origen.val();
  const destinoAbrev = campos.$destino.val();
  const montoTransaccion = parseFloat(campos.$valor.val());

  // Determinar qu√© moneda y monto enviar seg√∫n el tipo de operaci√≥n
  let monedaParaLimite, montoParaLimite;
  
  if (campos.op === "venta") {
    // COMPRA: cliente entrega PYG
    monedaParaLimite = "PYG";
    montoParaLimite = montoTransaccion;
  } else {
    // VENTA: cliente entrega USD/ARS/etc
    monedaParaLimite = origenAbrev;
    montoParaLimite = montoTransaccion;
  }
  
  console.log("Verificando l√≠mites:", montoParaLimite, monedaParaLimite, campos.op);
  
  verificarLimitesDisponibles(montoParaLimite, monedaParaLimite, campos.op, function(limiteOk) {
    if (!limiteOk) {
      // Si excede l√≠mites, detener el proceso completamente
      $("#modal-pin").fadeOut();
      $("#modal-exito").fadeOut(); // üî¥ ASEGURAR que el modal de √©xito NO se muestre
      return; // üö® Cortar ejecuci√≥n aqu√≠
    }
    
    // Si los l√≠mites est√°n OK, continuar con el proceso normal
    continuarProcesandoTransaccion();
  });
}

// Actualizar la funci√≥n verificarLimitesDisponibles para aceptar el tipo de operaci√≥n
function verificarLimitesDisponibles(montoTransaccion, monedaAbrev, tipoOperacion, callback) {
  $.ajax({
    url: "{% url 'verificar_limites' %}",
    type: "POST",
    data: {
      csrfmiddlewaretoken: "{{ csrf_token }}",
      monto: montoTransaccion,
      moneda: monedaAbrev,
      tipo_operacion: tipoOperacion  // Enviar el tipo de operaci√≥n
    },
    success: function(resp) {
      if (resp.success) {
        // Verificar si excede l√≠mite diario
        if (resp.excede_diario) {
          $("#modal-exito").fadeOut(); // üî¥ Ocultar modal de √©xito
          mostrarMensaje(
            "L√≠mite Diario Excedido",
            `Esta transacci√≥n excede tu l√≠mite diario disponible.\n\n` +
            `Monto solicitado: ${resp.moneda} ${resp.monto_solicitado}\n` +
            `Disponible hoy: ${resp.moneda} ${resp.disponible_diario}\n` +
            `L√≠mite diario: ${resp.moneda} ${resp.limite_diario}\n` +
            `Ya gastado: ${resp.moneda} ${resp.gastado_diario}\n\n` +
            `El l√≠mite se renovar√° a las 00:00:00 hs.`,
            "error"
          );
          callback(false);
          return;
        }
        
        // Verificar si excede l√≠mite mensual
        if (resp.excede_mensual) {
          $("#modal-exito").fadeOut(); // üî¥ Ocultar modal de √©xito
          mostrarMensaje(
            "L√≠mite Mensual Excedido",
            `Esta transacci√≥n excede tu l√≠mite mensual disponible.\n\n` +
            `Monto solicitado: ${resp.moneda} ${resp.monto_solicitado}\n` +
            `Disponible este mes: ${resp.moneda} ${resp.disponible_mensual}\n` +
            `L√≠mite mensual: ${resp.moneda} ${resp.limite_mensual}\n` +
            `Ya gastado: ${resp.moneda} ${resp.gastado_mensual}\n\n` +
            `El l√≠mite se renovar√° el d√≠a 1 del pr√≥ximo mes.`,
            "error"
          );
          callback(false);
          return;
        }
        
        // Si pasa todas las verificaciones
        callback(true);
      } else {
        $("#modal-exito").fadeOut(); // üî¥ Ocultar modal de √©xito
        mostrarMensaje("Error", resp.mensaje || "No se pudo verificar los l√≠mites", "error");
        callback(false);
      }
    },
    error: function() {
      $("#modal-exito").fadeOut(); // üî¥ Ocultar modal de √©xito
      mostrarMensaje("Error", "Error al verificar l√≠mites de transacci√≥n", "error");
      callback(false);
    }
  });
}

// Funci√≥n separada para continuar procesando la transacci√≥n
function continuarProcesandoTransaccion() {
  const campos = getCampos();
  const origenAbrev = campos.$origen.val();
  const destinoAbrev = campos.$destino.val();

  const moneda_origen_id = obtenerIdMoneda(origenAbrev);
  const moneda_destino_id = obtenerIdMoneda(destinoAbrev);

  console.log("ID origen:", moneda_origen_id, "ID destino:", moneda_destino_id);

  if (!moneda_origen_id || !moneda_destino_id) {
    mostrarMensaje("‚ö†Ô∏è Error", "No se pudieron encontrar los IDs de las monedas");
    return;
  }

  const email_cliente_operativo = "{{ email_cliente_operativo|default:'' }}";
  if (email_cliente_operativo != "") {
    const tasaCalculada = campos.$resultado.data("tasa") || 
                         (campos.op === "venta" ? 
                          parseFloat("{{ tasa_vta|floatformat:2 }}".replace(",", ".")) : 
                          parseFloat("{{ tasa_cmp|floatformat:2 }}".replace(",", ".")));
    
    // PARA BD LOCAL: Monto que el cliente ENTREGA (normalizado a PYG)
    let montoParaTransaccionBD;
    if (campos.op === "venta") {
      // COMPRA: usuario ENTREGA PYG (primer input)
      montoParaTransaccionBD = parseFloat($("#valor-compra").val());
    } else {
      // VENTA: usuario ENTREGA extranjera, convertir a PYG para BD
      montoParaTransaccionBD = parseFloat($("#resultado-venta").val()); // resultado en PYG
    }
    
    const payloadLocal = {
      usuario_id: "{{ request.user.id }}",
      monto: montoParaTransaccionBD, // Lo que ENTREGA el cliente (en PYG)
      tipo: campos.op === "venta" ? "compra" : "venta",
      estado: "pendiente",
      moneda_origen_id: moneda_origen_id,
      moneda_destino_id: moneda_destino_id,
      tasa_usada: tasaCalculada,
      tasa_ref_id: TASA_REF_ID,
      cliente_id: parseInt("{{ cliente_operativo_id }}", 10),
    };

    console.log("üíæ BD LOCAL - Lo que ENTREGA el cliente:", payloadLocal);

    fetch("{% url 'guardar_transaccion' %}", {
      method: "POST",
      credentials: "same-origin",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify(payloadLocal),
    })
    .then(resp => resp.json())
    .then(localResp => {
      console.log("Guardada en BD:", localResp);

      if (localResp.success) {
        const transaccionId = localResp.id;

        // üî• PARA BANCO: Enviar lo OPUESTO de lo que se guard√≥ en BD local
        let montoParaBanco, monedaParaBanco;
        
        if (campos.op === "venta") {
          // BD LOCAL guard√≥: PYG que cliente ENTREGA
          // BANCO debe recibir: Moneda extranjera que cliente RECIBE
          montoParaBanco = parseFloat($("#resultado-compra").val()); // USD/ARS/etc que recibe
          monedaParaBanco = $("#destino-compra").val(); // USD, ARS, etc.
          console.log(`üè¶ COMPRA: BD guard√≥ PYG entregados, Banco recibe ${montoParaBanco} ${monedaParaBanco} (lo que cliente recibe)`);
        } else {
          // BD LOCAL guard√≥: PYG equivalente de lo que cliente ENTREGA  
          // BANCO debe recibir: PYG que cliente RECIBE
          montoParaBanco = parseFloat($("#resultado-venta").val()); // PYG que recibe
          monedaParaBanco = "PYG";
          console.log(`üè¶ VENTA: BD guard√≥ PYG equivalente entregados, Banco recibe ${montoParaBanco} ${monedaParaBanco} (lo que cliente recibe)`);
        }

        const transaccionData = {
          email: "{{ email_cliente_operativo }}",
          monto: montoParaBanco, // üî• LO OPUESTO: Lo que cliente RECIBE
          moneda: monedaParaBanco, // üî• Moneda de lo que RECIBE
          tipo: campos.op === "venta" ? "compra" : "venta",
          estado: "aceptada",
          referencia: "TX-" + Date.now(),
          motivo: `Acreditaci√≥n por cambio de ${origenAbrev} a ${destinoAbrev}`,
          cedula: "{{cliente_operativo.cedula}}",
          nro_cuenta: window.datosAcreditacion.numero_cuenta,
          cliente_id: parseInt("{{ cliente_operativo.id }}", 10),
          entidad_id: 1,
          usuario_ejecutor: parseInt("{{ user.id }}", 10),
          fecha: new Date().toISOString()
        };

        console.log("üè¶ Datos para banco simulado (lo que RECIBE):", transaccionData);

        fetch("http://localhost:8001/api/transacciones/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(transaccionData),
        })
        .then(response => response.json())
        .then(bancoResp => {
          console.log("Respuesta del banco:", bancoResp);

          if (bancoResp.success || bancoResp.id) {
            // Actualizar estado en BD local
            fetch("{% url 'actualizar_estado_transaccion' %}", {
              method: "POST",
              credentials: "same-origin",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
              },
              body: JSON.stringify({
                transaccion_id: transaccionId,
                nuevo_estado: "completada"
              }),
            })
            .then(resp => resp.json())
            .then(updateResp => {
              console.log("Estado actualizado:", updateResp);
              
              // Mostrar √©xito
              mostrarModalExito({
                tipo: campos.op === "venta" ? "Compra" : "Venta",
                montoEntregado: campos.op === "venta" ? 
                  parseFloat($("#valor-compra").val()) : 
                  parseFloat($("#valor-venta").val()),
                monedaEntregada: campos.op === "venta" ? "PYG" : $("#origen-venta").val(),
                montoRecibido: montoParaBanco, // Lo que se acredit√≥ (lo que recibe)
                monedaRecibida: monedaParaBanco,
                numeroTransaccion: `TX-${transaccionId}`,
                cuentaDestino: window.datosAcreditacion.numero_cuenta,
                entidad: window.datosAcreditacion.entidad.nombre,
                tiempoAcreditacion: window.datosAcreditacion.tiempo_acreditacion || "2-3 minutos"
              });
            })
            .catch(err => {
              console.error("Error actualizando estado:", err);
              mostrarMensaje("‚ö†Ô∏è Advertencia", "Transacci√≥n procesada pero no se pudo actualizar el estado");
            });
          } else {
            mostrarMensaje("‚ùå Error", bancoResp.message || "Error en el banco simulado");
          }
        })
        .catch(bancoErr => {
          console.error("Error en banco:", bancoErr);
          mostrarMensaje("‚ùå Error", "No se pudo conectar con el banco simulado");
        });
      } else {
        mostrarMensaje("‚ö†Ô∏è Error", localResp.error || "No se pudo guardar la transacci√≥n inicial");
      }
    })
    .catch(localErr => {
      console.error("Error guardando localmente:", localErr);
      mostrarMensaje("‚ö†Ô∏è Error", "Error al guardar la transacci√≥n");
    });
  }
}

      
      $("#btn-cerrar-exito").click(function () {
        $("#modal-exito").fadeOut();
        $(".input-text").val("");
      });

      // Filtro tabla
      function aplicarFiltroUnico() {
        const columna = $('#filtro-columna').val(), query = $('#filtro-general').val().toLowerCase();
        $('.tabla-transacciones tbody tr').each(function () {
          const t = $(this); let valor = '';
          switch (columna) {
            case 'fecha': valor = t.find('td:nth-child(2)').text().toLowerCase(); break;
            case 'monto': valor = t.find('td:nth-child(3)').text().toLowerCase(); break;
            case 'moneda': valor = t.find('td:nth-child(4)').text().toLowerCase(); break;
            case 'estado': valor = t.find('td:nth-child(5)').text().toLowerCase(); break;
            case 'tipo': valor = t.find('td:nth-child(6)').text().toLowerCase(); break;
          }
          t.toggle(valor.includes(query));
        });
      }
      $('#filtro-general, #filtro-columna').on('input change', aplicarFiltroUnico);

    });
</script>

<style>
  .dashboard-grid {
    display: grid;
    grid-template-columns: minmax(300px, 1fr) minmax(350px, 1.2fr);
    gap: 2rem;
    max-width: 1400px;
    margin: 2rem auto;
  }
  .col-left {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .col-right {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .bloque-izquierdo {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    justify-content: center;
  }
  .conversor-container {
    padding: 1.5rem;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    text-align: center;
  }
  .title {
    color: #1e2d70;
    margin-bottom: 1rem;
    font-size: 1.4rem;
    font-weight: 600;
  }
  .conversor-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .fila {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .input-select,
  .input-text {
    padding: 0.6rem 0.8rem;
    border-radius: 10px;
    border: 1px solid #ddd;
    font-size: 0.95rem;
    flex: 1;
  }
  .input-text.readonly {
    background: #f4f6fb;
    color: #555;
    cursor: not-allowed;
  }
  .btn-convertir {
    background: #5d5fef;
    color: #fff;
    font-weight: 600;
    border: none;
    border-radius: 10px;
    padding: 0.8rem;
    cursor: pointer;
    transition: 0.3s;
  }
  .btn-convertir:hover {
    background: #4a4cd9;
  }
  .operacion-toggle {
    justify-content: center;
    gap: 1rem;
    display: flex;
    margin-bottom: 0.5rem;
  }
  .toggle-label {
    cursor: pointer;
    font-weight: 500;
  }
  .toggle-label input {
    margin-right: 0.3rem;
  }
  .input-icon-wrapper {
    position: relative;
  }
  .input-icon-wrapper .icono {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2rem;
    pointer-events: none;
  }
  .input-icon-wrapper .input-select {
    padding-left: 35px;
  }
  .transacciones-container {
    padding: 1.5rem;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    height: 100%;
  }
  .tabla-transacciones {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  .tabla-transacciones th,
  .tabla-transacciones td {
    padding: 0.8rem;
    border-bottom: 1px solid #eee;
    text-align: center;
    font-size: 0.9rem;
  }
  .tabla-transacciones tbody tr:nth-child(even) {
    background: #f9f9f9;
  }
  .tabla-transacciones td.tipo-compra::before {
    content: "üü¢ ";
  }
  .tabla-transacciones td.tipo-venta::before {
    content: "üî¥ ";
  }
  .estado.completada {
    color: #16a34a;
    font-weight: 600;
  }
  .estado.pendiente {
    color: #ca8a04;
    font-weight: 600;
  }
  .estado.cancelada {
    color: #dc2626;
    font-weight: 600;
  }
  .indicadores {
    display: flex;
    justify-content: space-around;
    gap: 1rem;
    padding: 1rem;
    border-radius: 12px;
  }
  .indicador {
    text-align: center;
  }
  .indicador .numero {
    font-size: 1.3rem;
    font-weight: 600;
    color: #1e2d70;
  }
  .indicador .label {
    font-size: 0.85rem;
    color: #555;
  }
  .estadisticas-rapidas {
    padding: 1rem;
    background: #f9f9f9;
    border-radius: 12px;
  }
  .estadisticas-rapidas h3 {
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
    color: #1e2d70;
  }
  .filtro-transacciones {
    display: flex;
    gap: 0.5rem;
    margin: 1rem 0;
  }
  .filtro-transacciones .input-select,
  .filtro-transacciones .input-text {
    flex: 1;
    padding: 0.6rem 0.8rem;
    border-radius: 10px;
    border: 1px solid #ddd;
  }
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
    z-index: 99999;
  }
  
  #mensaje-pin {
    display: none;
    font-weight: 600;
    color: red;
    margin-bottom: 0.5rem;
  }
  .pin-container {
    display: flex;
    justify-content: space-between;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  .pin-container .pin-digit {
    width: 50px;
    height: 50px;
    text-align: center;
    font-size: 1.4rem;
    border: 1px solid #ddd;
    border-radius: 8px;
  }
  .indicador-card {
    background: #fff;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(30, 45, 112, 0.1);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .indicador-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
  }

  .indicador-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #5d5fef, #4a4cd9);
  }

  .indicador-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #f4f6fb, #e8ecf7);
    border-radius: 12px;
    font-size: 1.5rem;
  }

  .indicador-content {
    flex: 1;
  }

  .numero {
    display: block;
    font-size: 1.2rem;
    font-weight: 700;
    color: #1e2d70;
    margin-bottom: 0.25rem;
  }

  .trend-indicator {
    font-size: 0.75rem;
    font-weight: 600;
    margin-top: 0.25rem;
  }

  .trend-indicator.up {
    color: #16a34a;
  }

  .trend-indicator.neutral {
    color: #666;
  }

  @media (max-width: 992px) {
    .dashboard-grid {
      grid-template-columns: 1fr;
    }
    .fila {
      flex-direction: column;
      align-items: stretch;
      gap: 0.5rem;
    }
    .input-icon-wrapper .input-select {
      width: 100%;
    }
    .indicadores {
      flex-wrap: wrap;
      justify-content: center;
    }
    .indicador {
      flex: 1 1 45%;
      margin-bottom: 1rem;
    }
    .col-right {
      margin-top: 2rem;
    }
  }
</style>


{% endblock %}