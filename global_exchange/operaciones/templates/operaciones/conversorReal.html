{% extends 'baseDashboardUsuario.html' %}
{% load static %}

{% block dashboard_content %}

<div class="dashboard-grid">

  <!-- COLUMNA IZQUIERDA -->
  <div class="col-left">
    <div class="bloque-izquierdo">

      <!-- Indicadores principales -->
      <section class="indicadores">
        <div class="indicador">
          <span class="numero">15</span>
          <span class="label">Transacciones totales</span>
        </div>
        <div class="indicador">
          <span class="numero">1,350 USD</span>
          <span class="label">Ganancia estimada</span>
        </div>
        <div class="indicador">
          <span class="numero">Venta</span>
          <span class="label">Ãšltima operaciÃ³n</span>
        </div>
      </section>

      <!-- EstadÃ­sticas rÃ¡pidas -->
      <section class="estadisticas-rapidas">
        <h3>ðŸ“Š EstadÃ­sticas rÃ¡pidas</h3>
        <p>Compras recientes: 8</p>
        <p>Ventas recientes: 7</p>
        <p>Monto promedio por operaciÃ³n: 950 USD</p>
      </section>

      <!-- Conversor -->
      <main class="conversor-container">
        <h2 class="title">ðŸ’± Conversor de Divisas</h2>
        <form id="form-conversor" method="post" class="conversor-form">
          {% csrf_token %}

          <div class="campo fila operacion-toggle">
            <label class="toggle-label">
              <input type="radio" name="operacion" value="venta" checked> Compra (entrego PYG)
            </label>
            <label class="toggle-label">
              <input type="radio" name="operacion" value="compra"> Venta (recibo PYG)
            </label>
          </div>

          <div class="campo fila">
            <div class="input-icon-wrapper">
              <span class="icono">ðŸ’µ</span>
              <select id="origen" name="origen" class="input-select">
                {% for moneda in monedas %}
                  <option value="{{ moneda.abreviacion }}">{{ moneda.nombre }} ({{ moneda.abreviacion }})</option>
                {% endfor %}
              </select>
            </div>
            <input type="text" id="valor" name="valor" class="input-text" placeholder="Monto">
          </div>

          <div class="campo fila">
            <div class="input-icon-wrapper">
              <span class="icono">ðŸ’²</span>
              <select id="destino" name="destino" class="input-select">
                {% for moneda in monedas %}
                  <option value="{{ moneda.abreviacion }}">{{ moneda.nombre }} ({{ moneda.abreviacion }})</option>
                {% endfor %}
              </select>
            </div>
            <input type="text" id="resultado" name="resultado" class="input-text readonly" placeholder="Resultado" readonly>
          </div>

          <button type="button" id="btn-enviar" class="btn-convertir">Enviar transacciÃ³n</button>
        </form>
      </main>

    </div>
  </div>

  <!-- COLUMNA DERECHA -->
  <div class="col-right">
    <section class="transacciones-container">
      <h2 class="title">ðŸ§¾ Transacciones Recientes</h2>
      <div class="filtro-transacciones">
        <select id="filtro-columna" class="input-select">
          <option value="fecha">Fecha</option>
          <option value="tipo">Tipo</option>
          <option value="monto">Monto</option>
          <option value="estado">Estado</option>
        </select>
        <input type="text" id="filtro-general" placeholder="Buscar..." class="input-text">
      </div>

      <table class="tabla-transacciones">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Monto</th>
            <th>Estado</th>
            <th>Tipo</th>
          </tr>
        </thead>
        <tbody>
          {% for t in transacciones %}
          <tr>
            <td>{{ t.id }}</td>
            <td>{{ t.fecha }}</td>
            <td>{{ t.monto }}</td>
            <td><span class="estado {{ t.estado|lower }}">{{ t.estado }}</span></td>
            <td class="tipo-{{ t.tipo|lower }}">{{ t.tipo }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <canvas id="grafico-transacciones" height="200" style="margin-top:1rem;"></canvas>
    </section>
  </div>

</div>

<!-- MODAL CONFIRMACIÃ“N -->
<div id="modal-confirmacion" class="modal">
  <div class="modal-content">
    <h3>Confirmar transacciÃ³n</h3>
    <p>Â¿Desea enviar esta transacciÃ³n?</p>
    <button id="btn-confirmar">Confirmar</button>
    <button id="btn-cancelar">Cancelar</button>
  </div>
</div>

<!-- MODAL PIN -->
<div id="modal-pin" class="modal">
  <div class="modal-content">
    <h3>Ingrese su PIN</h3>
    <p id="mensaje-pin" style="color:red; font-weight:600; display:none; margin-bottom:0.5rem;">PIN incorrecto</p>
    <div class="pin-container">
      <input type="text" maxlength="1" class="pin-digit">
      <input type="text" maxlength="1" class="pin-digit">
      <input type="text" maxlength="1" class="pin-digit">
      <input type="text" maxlength="1" class="pin-digit">
    </div>
    <button id="btn-verificar-pin">Verificar</button>
  </div>
</div>

<!-- MODAL Ã‰XITO -->
<div id="modal-exito" class="modal">
  <div class="modal-content">
    <h3>âœ… TransacciÃ³n realizada</h3>
    <p>Su transacciÃ³n se completÃ³ correctamente.</p>
    <button id="btn-cerrar-exito">Cerrar</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
$(document).ready(function(){

  // Conversor
  const $origen = $("#origen"), $destino = $("#destino"), $valor = $("#valor"), $resultado = $("#resultado");

  function actualizarCamposPorOperacion(){
    const op = $("input[name='operacion']:checked").val();
    $origen.prop("disabled", false);
    $destino.prop("disabled", false);
    $origen.find("option").prop("disabled", false);
    $destino.find("option").prop("disabled", false);
    if(op==="venta"){
      $origen.val("PYG").prop("disabled",true);
      $destino.find("option[value='PYG']").prop("disabled",true);
      if($destino.val()==="PYG") $destino.val($destino.find("option:not([value='PYG'])").first().val());
    }else{
      $destino.val("PYG").prop("disabled",true);
      $origen.find("option[value='PYG']").prop("disabled",true);
      if($origen.val()==="PYG") $origen.val($origen.find("option:not([value='PYG'])").first().val());
    }
    $resultado.val("");
  }
  actualizarCamposPorOperacion();
  $(document).on("change","input[name='operacion']",actualizarCamposPorOperacion);
  $valor.on("input",function(){this.value=this.value.replace(/[^0-9.]/g,'');});

  // BotÃ³n enviar transacciÃ³n -> abrir modal confirmaciÃ³n
  $("#btn-enviar").click(function(){ 
    $("#modal-confirmacion").css("display","flex"); // muestra y centra
    $("#modal-confirmacion").fadeIn(); 
  });
  $("#btn-cancelar").click(function(){ 
    $("#modal-confirmacion").fadeOut(); 
  });

  // Confirmar -> abrir modal PIN
  $("#btn-confirmar").click(function(){
    $("#modal-confirmacion").fadeOut();
    $("#modal-pin").fadeIn();
    $("#modal-pin").css("display","flex"); // muestra y centra
    $("#mensaje-pin").hide();
    $(".pin-digit").val("").first().focus();
  });

  // Foco automÃ¡tico en PIN
  $(".pin-digit").on("input", function() {
    let next = $(this).next(".pin-digit");
    if(this.value.length && next.length) { next.focus(); }
  });

  // Verificar PIN
  $("#btn-verificar-pin").click(function(){
    let pinIngresado = "";
    $(".pin-digit").each(function(){ pinIngresado += $(this).val(); });
    const pinCorrecto = "1234"; // estÃ¡tico
    if(pinIngresado===pinCorrecto){
      $("#modal-pin").fadeOut();
      $("#modal-exito").fadeIn();
      $("#modal-exito").css("display","flex");
      
    } else {
      $("#mensaje-pin").fadeIn();
      $(".pin-digit").val("").first().focus();
    }
  });

  // Cerrar modal Ã©xito
  $("#btn-cerrar-exito").click(function(){ 
    $("#modal-exito").fadeOut(); 
  });

  // Filtro tabla
  function aplicarFiltroUnico(){
    const columna=$('#filtro-columna').val(), query=$('#filtro-general').val().toLowerCase();
    $('.tabla-transacciones tbody tr').each(function(){
      const t=$(this); let valor='';
      switch(columna){
        case 'fecha': valor=t.find('td:nth-child(2)').text().toLowerCase(); break;
        case 'monto': valor=t.find('td:nth-child(3)').text().toLowerCase(); break;
        case 'estado': valor=t.find('td:nth-child(4)').text().toLowerCase(); break;
        case 'tipo': valor=t.find('td:nth-child(5)').text().toLowerCase(); break;
      }
      t.toggle(valor.includes(query));
    });
  }
  $('#filtro-general, #filtro-columna').on('input change',aplicarFiltroUnico);

  // Chart.js
  const ctx=document.getElementById('grafico-transacciones').getContext('2d');
  const dataTransacciones=[
    { dia:'15/09', tipo:'Compra', monto:1200 },
    { dia:'15/09', tipo:'Venta', monto:500 },
    { dia:'14/09', tipo:'Venta', monto:850 },
    { dia:'13/09', tipo:'Compra', monto:5000 },
    { dia:'12/09', tipo:'Venta', monto:3300 },
  ];
  new Chart(ctx,{
    type:'bar',
    data:{ labels:dataTransacciones.map(d=>d.dia), datasets:[{
      label:'Monto de transacciÃ³n',
      data:dataTransacciones.map(d=>d.monto),
      backgroundColor:dataTransacciones.map(d=>d.tipo==='Compra'?'#16a34a':'#dc2626')
    }]},
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });

});
</script>

<style>
.dashboard-grid{display:grid;grid-template-columns:minmax(300px,1fr) minmax(350px,1.2fr);gap:2rem;max-width:1200px;margin:2rem auto;}
.col-left{display:flex;flex-direction:column;justify-content:space-between;}
.col-right{display:flex;flex-direction:column;gap:1rem;}
.bloque-izquierdo{display:flex;flex-direction:column;gap:1rem;justify-content:center;}
.conversor-container{padding:1.5rem;background:#fff;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,0.08);text-align:center;}
.title{color:#1e2d70;margin-bottom:1rem;font-size:1.4rem;font-weight:600;}
.conversor-form{display:flex;flex-direction:column;gap:1rem;}
.fila{display:flex;align-items:center;gap:0.5rem;}
.input-select,.input-text{padding:0.6rem 0.8rem;border-radius:10px;border:1px solid #ddd;font-size:0.95rem;flex:1;}
.input-text.readonly{background:#f4f6fb;color:#555;cursor:not-allowed;}
.btn-convertir{background:#5d5fef;color:#fff;font-weight:600;border:none;border-radius:10px;padding:0.8rem;cursor:pointer;transition:0.3s;}
.btn-convertir:hover{background:#4a4cd9;}
.operacion-toggle{justify-content:center;gap:1rem;display:flex;margin-bottom:0.5rem;}
.toggle-label{cursor:pointer;font-weight:500;}
.toggle-label input{margin-right:0.3rem;}
.input-icon-wrapper{position:relative;}
.input-icon-wrapper .icono{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:1.2rem;pointer-events:none;}
.input-icon-wrapper .input-select{padding-left:35px;}
.transacciones-container{padding:1.5rem;background:#fff;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,0.08);}
.tabla-transacciones{width:100%;border-collapse:collapse;margin-top:1rem;}
.tabla-transacciones th,.tabla-transacciones td{padding:0.8rem;border-bottom:1px solid #eee;text-align:center;font-size:0.9rem;}
.tabla-transacciones tbody tr:nth-child(even){background:#f9f9f9;}
.tabla-transacciones td.tipo-compra::before{content:"ðŸŸ¢ ";}
.tabla-transacciones td.tipo-venta::before{content:"ðŸ”´ ";}
.estado.completada{color:#16a34a;font-weight:600;}
.estado.pendiente{color:#ca8a04;font-weight:600;}
.estado.cancelada{color:#dc2626;font-weight:600;}
.indicadores{display:flex;justify-content:space-around;gap:1rem;padding:1rem;background:#f4f6fb;border-radius:12px;}
.indicador{text-align:center;}
.indicador .numero{font-size:1.3rem;font-weight:600;color:#1e2d70;}
.indicador .label{font-size:0.85rem;color:#555;}
.estadisticas-rapidas{padding:1rem;background:#f9f9f9;border-radius:12px;}
.estadisticas-rapidas h3{margin-bottom:0.5rem;font-size:1.1rem;color:#1e2d70;}
.filtro-transacciones{display:flex;gap:0.5rem;margin:1rem 0;}
.filtro-transacciones .input-select,.filtro-transacciones .input-text{flex:1;padding:0.6rem 0.8rem;border-radius:10px;border:1px solid #ddd;}

/* MODALES */
.modal {
  display: none;               /* se oculta por defecto */
  position: fixed;
  inset: 0;                     /* top:0; right:0; bottom:0; left:0; */
  background: rgba(0,0,0,0.5);
  justify-content: center;      /* centrado horizontal */
  align-items: center;          /* centrado vertical */
  z-index: 9999;
}
.modal-content {
  background: #fff;
  padding: 2rem 1.5rem;
  border-radius: 12px;
  max-width: 400px;
  width: 90%;
  text-align: center;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  position: relative;
}
.modal-content button {
  margin: 0.5rem;
  padding: 0.6rem 1rem;
  border: none;
  border-radius: 8px;
  background: #5d5fef;
  color: #fff;
  cursor: pointer;
  transition: 0.3s;
}
.modal-content button:hover {
  background: #4a4cd9;
}
#mensaje-pin { display: none; font-weight:600; color:red; margin-bottom:0.5rem; }
.pin-container{display:flex;justify-content:space-between;gap:0.5rem;margin-bottom:1rem;}
.pin-container .pin-digit{width:50px;height:50px;text-align:center;font-size:1.4rem;border:1px solid #ddd;border-radius:8px;}

@media(max-width:992px){
  .dashboard-grid{grid-template-columns:1fr;}
  .fila{flex-direction:column;align-items:stretch;gap:0.5rem;}
  .input-icon-wrapper .input-select{width:100%;}
}
</style>

{% endblock %}
