<!-- MODAL MEDIOS DE ACREDITACI√ìN -->
<div id="modal-acreditacion" class="modal-acreditacion">
    <div class="modal-overlay" onclick="cerrarModalAcreditacion()"></div>
    <div class="modal-content-acreditacion">
        <div class="modal-header-acreditacion">
            <span class="close-btn" onclick="cerrarModalAcreditacion()">&times;</span>
            <h3 class="modal-title">Seleccione medio de acreditaci√≥n</h3>
            <p class="modal-subtitle">D√≥nde desea recibir: <span class="monto-acreditar" id="monto_a_acreditar"></span></p>
        </div>

        <div class="modal-body-acreditacion">
            <form id="form-medio-acreditacion" autocomplete="off">
                <!-- Medios de acreditaci√≥n din√°micos -->
                <div class="medios-container" id="medios-acreditacion-container">
                    <!-- Se llenar√°n din√°micamente desde la BD -->
                </div>
                <!-- Estado si no hay medios -->
                <div id="sin-medios" class="sin-medios" style="display: none;">
                    <div class="sin-medios-icon">üè¶</div>
                    <h4>No hay medios de acreditaci√≥n disponibles</h4>
                    <p>Para poder recibir sus fondos, debe configurar al menos un medio de acreditaci√≥n en su perfil.
                    </p>
                    <button type="button" class="btn-configurar" onclick="irAConfiguracion()">
                        Configurar medios
                    </button>
                </div>

                <div id="info-acreditacion" class="info-acreditacion" style="display:none;">
                    <div class="info-title">Detalle del medio seleccionado</div>
                    <div id="detalle-entidad"></div>
                    <div class="info-detalle"></div>
                </div>
            </form>
        </div>

        <div class="modal-footer-acreditacion">
            <button type="button" class="btn-modal-acreditacion secondary" onclick="cerrarModalAcreditacion()">
                <span>Cancelar</span>
            </button>
            <button type="button" class="btn-modal-acreditacion primary" id="btn-confirmar-acreditacion" disabled>
                <span>Confirmar acreditaci√≥n</span>
            </button>
        </div>
    </div>
</div>

<script>
    // Datos simulados desde la BD - en tu implementaci√≥n vendr√°n del backend
    const mediosAcreditacionData = JSON.parse('{{ medios_acreditacion|escapejs }}');


    let medioSeleccionado = null;

    function mostrarModalAcreditacion() {
        const modal = document.getElementById('modal-acreditacion');
        modal.style.display = 'flex';

        // Cargar medios de acreditaci√≥n
        cargarMediosAcreditacion();

        // Animaci√≥n de entrada
        const content = modal.querySelector('.modal-content-acreditacion');
        content.style.transform = 'scale(0.7) translateY(-50px)';
        content.style.opacity = '0';

        requestAnimationFrame(() => {
            content.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            content.style.transform = 'scale(1) translateY(0)';
            content.style.opacity = '1';
        });
    }

    function cerrarModalAcreditacion() {
        const modal = document.getElementById('modal-acreditacion');
        const content = modal.querySelector('.modal-content-acreditacion');

        content.style.transition = 'all 0.2s ease-out';
        content.style.transform = 'scale(0.7) translateY(-50px)';
        content.style.opacity = '0';

        setTimeout(() => {
            modal.style.display = 'none';
            resetearFormularioAcreditacion();
        }, 200);
    }

    function cargarMediosAcreditacion() {
        const container = document.getElementById('medios-acreditacion-container');
        const sinMedios = document.getElementById('sin-medios');

        if (mediosAcreditacionData.length === 0) {
            container.style.display = 'none';
            sinMedios.style.display = 'block';
            return;
        }

        container.innerHTML = '';
        sinMedios.style.display = 'none';

        mediosAcreditacionData.forEach(medio => {
            const medioElement = createMedioElement(medio);
            container.appendChild(medioElement);
        });
    }

    function createMedioElement(medio) {
        const div = document.createElement('div');
        div.className = 'medio-item';

        // Determinar icono seg√∫n tipo de entidad
        let icono = 'üè¶';
        switch (medio.entidad.tipo) {
            case 'BILLETERA':
                icono = 'üì±';
                break;
            case 'COOPERATIVA':
                icono = 'üè¢';
                break;
            case 'FINTECH':
                icono = 'üí≥';
                break;
        }

        // Renderizar campos din√°micos
        let camposHtml = '';
        medio.campos.forEach(campo => {
            camposHtml += `<div><strong>${campo.label}:</strong> ${campo.value}</div>`;
        });

        div.innerHTML = `
                <input type="radio" id="medio-${medio.id}" name="medio_acreditacion" value="${medio.id}" class="medio-radio">
                <label for="medio-${medio.id}" class="medio-label">
                    <div class="medio-icon">${icono}</div>
                    <div class="medio-info">
                        <span class="medio-nombre">${medio.entidad.nombre}</span>
                        <span class="medio-desc">${camposHtml}</span>
                    </div>
                    <div class="medio-check">‚úì</div>
                </label>
            `;

        // Agregar event listener
        const radio = div.querySelector('.medio-radio');
        radio.addEventListener('change', () => {
            if (radio.checked) {
                seleccionarMedio(medio);
            }
        });

        return div;
    }

    function seleccionarMedio(medio) {
        medioSeleccionado = medio;
        console.log("entra a la funcion");

        // Mostrar informaci√≥n del medio seleccionado
        const infoAcreditacion = document.getElementById('info-acreditacion');
        infoAcreditacion.style.display = 'block';

        // Mostrar todos los campos din√°micos en el detalle
        const detalleEntidad = document.getElementById('detalle-entidad');
        detalleEntidad.textContent = medio.entidad.nombre;

        // Limpiar y mostrar campos din√°micos
        const infoDetalle = document.querySelector('.info-detalle');
        infoDetalle.innerHTML = '';
        medio.campos.forEach(campo => {
            const row = document.createElement('div');
            row.className = 'detalle-row';
            row.innerHTML = `<span class="detalle-label">${campo.label}:</span><span class="detalle-valor">${campo.value}</span>`;
            infoDetalle.appendChild(row);
        });
        console.log("LLEGA HASTA ACA");
        // Habilitar bot√≥n de confirmar
        document.getElementById('btn-confirmar-acreditacion').disabled = false;

        // Animaci√≥n suave
        infoAcreditacion.style.opacity = '0';
        infoAcreditacion.style.transform = 'translateY(-10px)';

        setTimeout(() => {
            infoAcreditacion.style.transition = 'all 0.3s ease';
            infoAcreditacion.style.opacity = '1';
            infoAcreditacion.style.transform = 'translateY(0)';
        }, 10);
    }

    function confirmarAcreditacion() {
        if (!medioSeleccionado) {
            window.mostrarMensajeModal("Info",'Por favor seleccione un medio de acreditaci√≥n','info');
            return;
        }

         // üö® Si no hay ning√∫n campo definido
    if (!medioSeleccionado.campos || medioSeleccionado.campos.length === 0) {
        window.mostrarMensajeModal("Error","El medio seleccionado no tiene datos configurados. Debe completar los datos de acreditaci√≥n en la Configuracion.");
        return;
    }

        // Validar que todos los campos requeridos tengan valor
    const camposFaltantes = medioSeleccionado.campos.filter(campo => {
        // si "campo" es un input HTML real
        let valor = campo.value !== undefined ? campo.value : "";
        valor = valor.toString().trim();
        return valor === "";
    });

    console.log("confirmarAcreditacion",camposFaltantes)
    if (camposFaltantes.length > 0) {
        let nombres = camposFaltantes.map(c => c.label || c.name || "(campo)").join(", ");
        alert("‚ö†Ô∏è El medio seleccionado no tiene datos completos. Debe completar: " + nombres);
        return;
    }

        window.datosAcreditacion = medioSeleccionado;

        // Cerrar modal
        cerrarModalAcreditacion();

        if (window.mfaTransacciones) {
            mostrarModalPin();   // pedir PIN
        } else {
            procesarTransaccion(); // ir directo
        }
    }

    function resetearFormularioAcreditacion() {
        // Limpiar selecci√≥n
        const radios = document.querySelectorAll('input[name="medio_acreditacion"]');
        radios.forEach(radio => radio.checked = false);

        // Ocultar informaci√≥n
        document.getElementById('info-acreditacion').style.display = 'none';

        // Deshabilitar bot√≥n
        document.getElementById('btn-confirmar-acreditacion').disabled = true;

        // Limpiar variable
        medioSeleccionado = null;
    }

    function irAConfiguracion() {
        alert('Redirigir a configuraci√≥n de medios de acreditaci√≥n');
        // Aqu√≠ redirigir√≠as al CRUD de medios de acreditaci√≥n
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('btn-confirmar-acreditacion').addEventListener('click', confirmarAcreditacion);

        // Cerrar con ESC
        document.addEventListener('keydown', function (e) {
            const modal = document.getElementById('modal-acreditacion');
            if (e.key === 'Escape' && modal && modal.style.display === 'flex') {
                cerrarModalAcreditacion();
            }
        });
    });

    // Funci√≥n para cargar medios desde el backend (para tu implementaci√≥n)
    function cargarMediosDesdeBackend(clienteId) {
        // En tu implementaci√≥n real, har√≠as una llamada AJAX:
        /*
        fetch(`/api/clientes/${clienteId}/medios-acreditacion/`)
            .then(response => response.json())
            .then(data => {
                mediosAcreditacionData = data;
                cargarMediosAcreditacion();
            })
            .catch(error => {
                console.error('Error cargando medios:', error);
                document.getElementById('sin-medios').style.display = 'block';
            });
        */
    }
    function getCampos() {
    const op = $("input[name='operacion']:checked").val();
    if(op === "venta"){ // compra inputs activos
      return {
        $origen: $("#origen-compra"),
        $destino: $("#destino-compra"),
        $valor: $("#valor-compra"),
        $resultado: $("#resultado-compra"),
        op
      };
    } else { // venta inputs activos
      return {
        $origen: $("#origen-venta"),
        $destino: $("#destino-venta"),
        $valor: $("#valor-venta"),
        $resultado: $("#resultado-venta"),
        op
      };
    }
}


function actualizarMonto() {
    const campos = getCampos();  // obtiene los inputs activos seg√∫n operaci√≥n
    const total = campos.$resultado.val();        // valor del input resultado
    const moneda_a_pagar = campos.$destino.val(); // moneda destino

    $("#monto_a_acreditar").text(total + " " + moneda_a_pagar);
}
// Llamar cuando cambia la operaci√≥n
$("input[name='operacion']").change(actualizarMonto);

// Llamar cuando cambia el input de valor o cuando se hace la conversi√≥n
$("#valor-compra, #valor-venta").on("input", actualizarMonto);

// O si tienes un bot√≥n de conversi√≥n:
$("#btn-convertir").click(actualizarMonto);

    
</script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f4f6fb;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .demo-btn {
        background: #5d5fef;
        color: white;
        border: none;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .demo-btn:hover {
        background: #4a4cd9;
        transform: translateY(-2px);
    }

    /* MODAL ACREDITACI√ìN */
    .modal-acreditacion {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        justify-content: center;
        align-items: center;
        z-index: 10000;
        padding: 1rem;
    }

    .modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
    }

    .modal-content-acreditacion {
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        position: relative;
        z-index: 1;
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header-acreditacion {
        padding: 2rem 2rem 1rem;
        text-align: center;
        position: relative;
        border-bottom: 1px solid #e8ecf7;
    }

    .close-btn {
        position: absolute;
        top: 1rem;
        right: 1.5rem;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f4f6fb;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        color: #666;
        transition: all 0.2s ease;
    }

    .close-btn:hover {
        background: #e8ecf7;
        color: #1e2d70;
    }

    .modal-title {
        color: #1e2d70;
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .modal-subtitle {
        color: #666;
        font-size: 0.95rem;
    }

    .monto-acreditar {
        color: #16a34a;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .modal-body-acreditacion {
        padding: 1.5rem 2rem;
    }

    .modal-footer-acreditacion {
        padding: 1rem 2rem 2rem;
        display: flex;
        gap: 0.75rem;
        border-top: 1px solid #e8ecf7;
    }

    /* MEDIOS DE ACREDITACI√ìN */
    .medios-container {
        margin-bottom: 1.5rem;
    }

    .medio-item {
        margin-bottom: 0.75rem;
    }

    .medio-radio {
        display: none;
    }

    .medio-label {
        display: flex;
        align-items: center;
        padding: 1rem;
        border: 2px solid #e8ecf7;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fff;
        position: relative;
    }

    .medio-radio:checked+.medio-label {
        border-color: #5d5fef;
        background: #f8f8ff;
    }

    .medio-radio:checked+.medio-label .medio-check {
        opacity: 1;
        transform: scale(1);
    }

    .medio-label:hover {
        border-color: #c2c9d6;
        background: #f9fafc;
    }

    .medio-icon {
        font-size: 1.5rem;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .medio-info {
        flex: 1;
        text-align: left;
    }

    .medio-nombre {
        display: block;
        font-weight: 600;
        color: #1e2d70;
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
    }

    .medio-desc {
        display: block;
        color: #666;
        font-size: 0.8rem;
    }

    .medio-check {
        width: 20px;
        height: 20px;
        background: #5d5fef;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.8rem;
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    /* INFORMACI√ìN DE ACREDITACI√ìN */
    .info-acreditacion {
        background: #f4f6fb;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #e8ecf7;
        margin-top: 1rem;
        transition: all 0.3s ease;
    }

    .info-title {
        color: #1e2d70;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .info-detalle {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e8ecf7;
        margin-bottom: 1rem;
    }

    .detalle-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        align-items: center;
    }

    .detalle-row:last-child {
        margin-bottom: 0;
    }

    .detalle-label {
        color: #666;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .detalle-valor {
        color: #1e2d70;
        font-weight: 600;
        font-size: 0.9rem;
        text-align: right;
    }

    .tiempo-acreditacion {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: #e8f5e8;
        border: 1px solid #c6f6d5;
        border-radius: 8px;
        padding: 0.75rem;
    }

    .tiempo-icon {
        font-size: 1.2rem;
    }

    .tiempo-info {
        flex: 1;
    }

    .tiempo-label {
        display: block;
        color: #065f46;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .tiempo-valor {
        display: block;
        color: #047857;
        font-weight: 600;
        font-size: 0.9rem;
    }

    /* SIN MEDIOS */
    .sin-medios {
        text-align: center;
        padding: 2rem;
        background: #f9f9f9;
        border-radius: 12px;
        border: 2px dashed #ddd;
    }

    .sin-medios-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.6;
    }

    .sin-medios h4 {
        color: #1e2d70;
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
    }

    .sin-medios p {
        color: #666;
        font-size: 0.95rem;
        margin-bottom: 1.5rem;
        line-height: 1.5;
    }

    .btn-configurar {
        background: #5d5fef;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-configurar:hover {
        background: #4a4cd9;
        transform: translateY(-1px);
    }

    /* BOTONES */
    .btn-modal-acreditacion {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        border: none;
        border-radius: 12px;
        padding: 0.9rem 1.5rem;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
    }

    .btn-modal-acreditacion:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .btn-modal-acreditacion.primary {
        background: #5d5fef;
        color: #fff;
    }

    .btn-modal-acreditacion.primary:hover:not(:disabled) {
        background: #4a4cd9;
        transform: translateY(-1px);
    }

    .btn-modal-acreditacion.secondary {
        background: #f4f6fb;
        color: #666;
        border: 1px solid #e8ecf7;
    }

    .btn-modal-acreditacion.secondary:hover {
        background: #e8ecf7;
        color: #1e2d70;
    }

    /* RESPONSIVE */
    @media (max-width: 500px) {
        .modal-content-acreditacion {
            max-width: 95%;
            margin: 1rem;
        }

        .modal-header-acreditacion,
        .modal-body-acreditacion,
        .modal-footer-acreditacion {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }

        .medio-label {
            padding: 0.75rem;
        }

        .medio-icon {
            font-size: 1.2rem;
            margin-right: 0.75rem;
        }

        .modal-footer-acreditacion {
            flex-direction: column;
        }

        .detalle-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }

        .detalle-valor {
            text-align: left;
        }
    }
</style>