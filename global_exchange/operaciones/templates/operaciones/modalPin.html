<!-- MODAL PIN -->
<div id="modal-pin" class="modal-pin">
  <div class="modal-overlay" onclick="cerrarModalPin()"></div>
  <div class="modal-content-pin">
    <div class="modal-header-pin">
      <div class="modal-icon-pin">
        <span>üîê</span>
      </div>
      <h3 class="modal-title-pin">Verificaci√≥n de seguridad</h3>
      <button class="modal-close-pin" onclick="cerrarModalPin()">
        &times;
      </button>
    </div>

    <div class="modal-body-pin">
      <p class="pin-instruction">Ingrese su PIN de 4 d√≠gitos para continuar</p>

      <div class="pin-error" id="mensaje-pin" style="display: none">
        <span class="error-icon">‚ö†Ô∏è</span>
        <span>PIN incorrecto. Intente nuevamente.</span>
      </div>

      <div class="pin-container">
        <input type="text" maxlength="1" class="pin-digit" data-index="0" />
        <input type="text" maxlength="1" class="pin-digit" data-index="1" />
        <input type="text" maxlength="1" class="pin-digit" data-index="2" />
        <input type="text" maxlength="1" class="pin-digit" data-index="3" />
      </div>

      <div class="security-info">
        <span class="security-icon">üõ°Ô∏è</span>
        <span>Tu informaci√≥n est√° protegida con encriptaci√≥n SSL</span>
      </div>
    </div>

    <div class="modal-footer-pin">
      <button class="btn-modal-pin"  id = "btn-verificar-pin" onclick="verificarPin()">
        <span>Verificar PIN</span>
      </button>
    </div>
  </div>
</div>

<div id="modal-loader-pin" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-icon-container">
      <div class="modal-icon" id="loader-icon">‚è≥</div>
      <h3 id="loader-title">Enviando PIN</h3>
    </div>
    <p id="loader-text">Por favor, espere mientras se env√≠a el PIN de verificaci√≥n...</p>
  </div>
</div>

<!-- MODAL LOADER TRANSACCI√ìN -->
<div id="modal-loader-transaccion" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-icon-container">
      <div class="modal-icon" id="loader-icon-transaccion">‚è≥</div>
      <h3 id="loader-title-transaccion">Procesando transacci√≥n</h3>
    </div>
    <p id="loader-text-transaccion">Conectando con el banco y validando la operaci√≥n. Por favor, espere...</p>
  </div>
</div>


<script>
  function mostrarModalPin() {
    console.log("mostrarModalPinnnnnnnnnnnnnnnnn");
    enviarPin();
    const modal = document.getElementById("modal-pin");
    modal.style.display = "flex";

    // Animaci√≥n de entrada
    const content = modal.querySelector(".modal-content-pin");
    content.style.transform = "scale(0.7) translateY(-50px)";
    content.style.opacity = '0';
    // Resetear estados previos de animaci√≥n
    content.style.transition = "none";
    console.log("mostrarModalPin");

    requestAnimationFrame(() => {
      console.log("requestAnimationFrame");
      content.style.transition =
        "all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)";
      content.style.transform = "scale(1) translateY(0)";
      content.style.opacity = "1";
      console.log("requestAnimationFrame");
    });

    // Focus en el primer input
    setTimeout(() => {
      document.querySelector(".pin-digit").focus();
    }, 100);
  }

  function cerrarModalPin() {
    const modal = document.getElementById("modal-pin");
    const content = modal.querySelector(".modal-content-pin");

    content.style.transition = "all 0.2s ease-out";
    content.style.transform = "scale(0.7) translateY(-50px)";
    content.style.opacity = "0";

    setTimeout(() => {
      modal.style.display = "none";
      // Reset PIN inputs
      document.querySelectorAll(".pin-digit").forEach((input) => {
        input.value = "";
        input.classList.remove("error");
      });
      document.getElementById("mensaje-pin").style.display = "none";
    }, 200);
  }

  function mostrarMensaje(titulo, texto,tipo='warning',recargar) {
    console.log("mostrarMensaje en Pin:", titulo, texto);
    
    if (window.mostrarMensajeModal) {
      // Mostrar mensaje
      window.mostrarMensajeModal(titulo, texto,tipo,recargar);
    } else {
      console.error("Modal mensaje no disponible desde PIN");
      alert(titulo + ": " + texto);
    }
}

  function getCampos() {
    const op = $("input[name='operacion']:checked").val();
    if(op === "venta"){ // compra inputs activos
      return {
        $origen: $("#origen-compra"),
        $destino: $("#destino-compra"),
        $valor: $("#valor-compra"),
        $resultado: $("#resultado-compra"),
        op
      };
    } else { // venta inputs activos
      return {
        $origen: $("#origen-venta"),
        $destino: $("#destino-venta"),
        $valor: $("#valor-venta"),
        $resultado: $("#resultado-venta"),
        op
      };
    }
  }

function verificarTasaActualizada(callback) {
  fechaNavegador =window.fechaNavegador
        const campos = getCampos();
        console.log("Verificando tasa para:", campos.$origen.val(), "->", campos.$destino.val());

        $.ajax({
          url: "{% url 'verificar_tasa' %}",
          type: "GET",
          data: {
            origen: campos.op == "venta" ? campos.$origen.val() : campos.$destino.val(),
            destino: campos.op == "venta" ? campos.$destino.val() : campos.$origen.val()
          },
          success: function (resp) {
            const fechaBaseDatos = new Date(resp.fecha_tasa);
            console.log("fechaNavegador:", fechaNavegador);
            console.log("fechaBaseDatos:", fechaBaseDatos);

            if (fechaBaseDatos > fechaNavegador) {
              // ‚ö†Ô∏è La tasa ya cambi√≥
              $("#btn-continuar-tasa").show();   // mostrar bot√≥n de recalcular
                      // ocultar bot√≥n de confirmar
              advertenciaMostrada = true;

              if (callback) callback(false); // avisar que NO puede continuar
              return;
            } else {
              if (callback) callback(true);  // tasa ok
            }
          },
          error: function() {
            console.error("Error al verificar tasa");
            if (callback) callback(true); // En caso de error, permitir continuar
          }
        });
      }

  // Funci√≥n principal para verificar el PIN
function verificarPin() {
  console.log("verificarPin en modalPin");

  const pinInputs = document.querySelectorAll(".pin-digit");
  let pin = "";
  pinInputs.forEach((input) => pin += input.value);

  fetch("{% url 'validar_pin' %}", {
      method: "POST",
      credentials: "same-origin",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: new URLSearchParams({ pin: pin })
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.success) {
        cerrarModalPin();
        
        // Verificar tasa actualizada
        verificarTasaActualizada(function(tasaActualizada) {
          if (tasaActualizada) {
            console.log("PIN correcto y tasa actualizada, procesando transacci√≥n...");
            
            // üî• PRIMERO: Procesar transacci√≥n bancaria
            // üî• NO procesar pago Stripe aqu√≠
            procesarTransaccion();

          } else {
            // Tasa desactualizada
            $("#modal-exito").css("display", "none");
            mostrarMensaje(
              "Transacci√≥n Rechazada",
              "‚ö†Ô∏è La tasa de cambio usada ya no es la m√°s reciente. Tiene que volver a recalcular para usar la √∫ltima tasa.",
              "warning",
              true
            );
            $("#modal-pin").fadeOut();
          }
        });
      } else {
        // PIN incorrecto
        console.log("PIN incorrecto:", pin);
        document.getElementById("mensaje-pin").style.display = "block";
        pinInputs.forEach((input) => {
          input.value = "";
          input.classList.add("error");
        });
        pinInputs[0].focus();

        setTimeout(() => {
          pinInputs.forEach((input) => input.classList.remove("error"));
        }, 2000);
      }
    })
    .catch(err => {
      console.error("Error verificando PIN:", err);
    });
  
  pinInputs.forEach((input) => input.value = "");
}

function mostrarLoaderTransaccion() {
  $("#modal-loader-transaccion").fadeIn().css("display", "flex");
}

function ocultarLoaderTransaccion() {
  $("#modal-loader-transaccion").fadeOut();
}


// Funci√≥n separada para procesar y guardar la transacci√≥n
function procesarTransaccion() {
  console.log("Procesando transacci√≥n en modalPin");

  // Mostrar loader mientras se conecta al banco
  mostrarLoaderTransaccion();

  const campos = getCampos();
  const origenAbrev = campos.$origen.val();
  const destinoAbrev = campos.$destino.val();

  const moneda_origen_id = window.obtenerIdMoneda(origenAbrev);
  const moneda_destino_id = window.obtenerIdMoneda(destinoAbrev);

  if (!moneda_origen_id || !moneda_destino_id) {
    mostrarMensaje("‚ö†Ô∏è Error", "No se pudieron encontrar los IDs de las monedas");
    return;
  }

  const email_cliente_operativo = "{{ email_cliente_operativo|default:'' }}";
  if (email_cliente_operativo === "") {
    console.log("No se encontr√≥ el email del cliente operativo.");
    $("#modal-pin").fadeOut();
    mostrarMensaje("‚ö†Ô∏è Error", "No se encontr√≥ el email del cliente operativo.");
    return;
  }

  const tasaCalculada = campos.$resultado.data("tasa") ||
    (campos.op === "venta" ? parseFloat("{{ tasa_vta|floatformat:2 }}".replace(",", ".")) :
                             parseFloat("{{ tasa_cmp|floatformat:2 }}".replace(",", ".")));

  let gananciaCalculada;
  PB_MONEDA="{{ PB_MONEDA }}"
  if (campos.op === "venta") {
      const valor = parseFloat($("#valor-compra").val());
      gananciaCalculada = valor - (valor / tasaCalculada * PB_MONEDA);
  } else {
      const valor = parseFloat($("#valor-venta").val());
      gananciaCalculada = valor * PB_MONEDA - (valor * tasaCalculada);
  }

  // PASO 1: Guardar en BD como PENDIENTE
  const payloadLocal = {
    usuario_id: "{{ request.user.id }}",
    monto: typeof window.monto_total_con_comision !== "undefined"
        ? window.monto_total_con_comision
        : parseFloat(campos.op === "venta" ? $("#valor-compra").val() : $("#valor-venta").val()),
    tipo: campos.op === "venta" ? "compra" : "venta",
    estado: "pendiente",
    moneda_origen_id: moneda_origen_id,
    moneda_destino_id: moneda_destino_id,
    tasa_usada: tasaCalculada,
    tasa_ref_id: TASA_REF_ID,
    cliente_id:  parseInt("{{ cliente_operativo.id }}", 10),
    ganancia:window.ganancia_total,
  };

  console.log("Guardando en BD LOCAL modalPin:", payloadLocal);

  fetch("{% url 'guardar_transaccion' %}", {
    method: "POST",
    credentials: "same-origin",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify(payloadLocal)
  })
  .then(resp => resp.json())
  .then(localResp => {
    if (!localResp.success) {
      mostrarMensaje("‚ö†Ô∏è Error", "No se pudo guardar la transacci√≥n inicial");
      return;
    }

    const transaccionId = localResp.id;

    // PASO 2: Enviar al banco
    let montoParaBanco, monedaParaBanco;
    
    if (campos.op === "venta") {
      montoParaBanco = parseFloat($("#resultado-compra").val());
      monedaParaBanco = $("#destino-compra").val();
    } else {
      montoParaBanco = parseFloat($("#resultado-venta").val());
      monedaParaBanco = "PYG";
    }

    const transaccionData = {
      email: "{{ email_cliente_operativo }}",
      monto: montoParaBanco,
      moneda: monedaParaBanco,
      tipo: campos.op === "venta" ? "compra" : "venta",
      estado: "aceptada",
      referencia: "TX-" + Date.now(),
      motivo: `Cambio de ${origenAbrev} a ${destinoAbrev}`,
      cedula: "{{cliente_operativo.cedula}}",
      //nro_cuenta: window.datosAcreditacion.numero_cuenta,
      cliente_id: parseInt("{{ cliente_operativo.id }}", 10),
      entidad_id: 1,
      usuario_ejecutor: parseInt("{{ user.id }}", 10),
      fecha: new Date().toISOString()
    };

    // Validar que transaccionData no tenga valores undefined o vac√≠os
    const valoresInvalidos = Object.entries(transaccionData).filter(([k, v]) => {
      return v === undefined || v === null || v === "";
    });
    if (valoresInvalidos.length > 0) {
  console.error("‚ùå Transacci√≥n inv√°lida, faltan datos:", valoresInvalidos);
  mostrarMensaje("‚ö†Ô∏è Error", "La transacci√≥n no se pudo enviar. Faltan datos obligatorios.");
  return; // üî• Detener aqu√≠
}

    console.log("üè¶ Enviando al banco:", transaccionData);

    fetch("http://127.0.0.1:8001/transaccion/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(transaccionData)
    })
    .then(resp => resp.json())
    .then(async data => { // üî• async aqu√≠
      console.log("Respuesta del banco:", data);
      ocultarLoaderTransaccion(); // Ocultar loader al recibir respuesta

      let estadoFinal = "pendiente";
      
      if (data.estado === "ok"){
        estadoFinal = "completada";
        
        // Guardar transacci√≥n globalmente
        window.transaccionActual = {
          ...window.datos,
          ...window.datosAcreditacion,
          ...transaccionData      
        };

        // üî• PASO 3: Si el banco aprob√≥ Y hay pago con tarjeta, procesarlo AHORA
        if (window.metodoSeleccionado === "tarjeta") {
          console.log("üí≥ Banco aprob√≥, procesando pago con tarjeta...");
          
          const pagoExitoso = await procesarPagoStripe();
          
          if (!pagoExitoso) {
            console.error("‚ùå Pago con tarjeta fall√≥ despu√©s de aprobaci√≥n bancaria");
            estadoFinal = "cancelada"; // üî• Cambiar estado a cancelada
            
            mostrarMensaje(
              "Error de Pago",
              "La transacci√≥n bancaria fue aprobada pero el pago con tarjeta fall√≥. Por favor contacte con soporte.",
              "error"
            );
            
            // Actualizar estado a cancelada y retornar
            const payloadCancelacion = {
              transaccion_id: transaccionId,
              nuevo_estado: "cancelada"
            };
            
            await fetch("{% url 'actualizar_estado_transaccion' %}", {
              method: "POST",
              credentials: "same-origin",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
              },
              body: JSON.stringify(payloadCancelacion)
            });
            
            return; // üî• Detener aqu√≠
          }
          
          console.log("‚úÖ Pago con tarjeta exitoso");
        }
        
      } else if (data.estado === "rechazada") {
        estadoFinal = "cancelada";
      }

      // PASO 4: Actualizar estado en BD
      const payloadActualizacion = {
        transaccion_id: transaccionId,
        nuevo_estado: estadoFinal
      };

      fetch("{% url 'actualizar_estado_transaccion' %}", {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify(payloadActualizacion)
      })
      .then(resp => resp.json())
      .then(updateResp => {
        console.log("updateResp",updateResp)
        if (updateResp.success) {
          if (estadoFinal === "completada") {
            // üî• SOLO AQU√ç SE MUESTRA EL MODAL DE √âXITO
            $("#modal-pin").fadeOut();
            $("#modal-exito").fadeIn().css("display", "flex");
          } else {
            mostrarMensaje("Transacci√≥n rechazada", data.mensaje || "Rechazada por el banco",'warning',true);
          }
        } else {
          mostrarMensaje("‚ö†Ô∏è Error", "No se pudo actualizar el estado de la transacci√≥n");
        }
      })
      .catch(err => {
        console.error("Error actualizando estado:", err);
        ocultarLoaderTransaccion(); // Ocultar loader al recibir respuesta
        mostrarMensaje("‚ö†Ô∏è Error", "Error al actualizar el estado de la transacci√≥n");
      });

    })
    .catch(err => {
      console.error("Error enviando transacci√≥n:", err);
      ocultarLoaderTransaccion(); // Ocultar loader al recibir respuesta

      // Si falla el banco, actualizar a "cancelada"
      const payloadError = { transaccion_id: transaccionId, nuevo_estado: "cancelada" };
      fetch("{% url 'actualizar_estado_transaccion' %}", {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify(payloadError)
      });

      mostrarMensaje("‚ö†Ô∏è Error", "Error al conectar con el banco");
    });
  })
  .catch(err => {
    console.error("Error guardando en BD:", err);
    ocultarLoaderTransaccion(); // Ocultar loader al recibir respuesta
    mostrarMensaje("‚ö†Ô∏è Error", "No se pudo guardar la transacci√≥n localmente");
  });
}

function mostrarLoaderPin() {
  $("#modal-loader-pin").fadeIn().css("display", "flex");
}

function ocultarLoaderPin() {
  $("#modal-loader-pin").fadeOut();
}


function enviarPin() {
  const pinInputs = document.querySelectorAll(".pin-digit");
  const btnVerificar = document.getElementById("btn-verificar-pin");

  // Desactivar inputs y bot√≥n
  pinInputs.forEach(i => i.disabled = true);
  btnVerificar.disabled = true;

  // Mostrar loader
  mostrarLoaderPin();

  fetch("{% url 'enviar_pin' %}", { method: "GET", credentials: "same-origin" })
    .then(resp => resp.json())
    .then(data => {
      // Ocultar loader y reactivar inputs
      ocultarLoaderPin();
      pinInputs.forEach(i => i.disabled = false);
      btnVerificar.disabled = false;

      if (data.success) {
        console.log("PIN enviado ‚úÖ");
        mostrarExito("PIN Enviado", "Se ha enviado el PIN de verificaci√≥n a su correo electr√≥nico.");
        document.getElementById("modal-pin").style.display = "flex";
        pinInputs[0].focus();
      } else {
        console.error("Error enviando PIN:", data.message);
        mostrarMensaje("Error", "No se pudo enviar el PIN. Intente nuevamente.", "error");
      }
    })
    .catch(err => {
      console.error("Error:", err);
      ocultarLoaderPin();
      pinInputs.forEach(i => i.disabled = false);
      btnVerificar.disabled = false;
      mostrarMensaje("Error", "Ocurri√≥ un error al enviar el PIN.", "error");
    });
}

  // Funcionalidad PIN
  document.addEventListener("DOMContentLoaded", function () {
    const pinInputs = document.querySelectorAll(".pin-digit");

    pinInputs.forEach((input, index) => {
      input.addEventListener("input", function () {
        // Solo permitir n√∫meros
        this.value = this.value.replace(/[^0-9]/g, "");

        if (this.value.length === 1) {
          if (index < pinInputs.length - 1) {
            pinInputs[index + 1].focus();
          }
        }
      });

      input.addEventListener("keydown", function (e) {
        if (e.key === "Backspace" && this.value === "") {
          if (index > 0) {
            pinInputs[index - 1].focus();
          }
        }
        if (e.key === "Enter") {
          verificarPin();
        }
      });

      input.addEventListener("paste", function (e) {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData("text");
        const digits = paste.replace(/[^0-9]/g, "").split("");

        digits.forEach((digit, i) => {
          if (index + i < pinInputs.length) {
            pinInputs[index + i].value = digit;
          }
        });

        if (digits.length >= 4) {
          verificarPin();
        }
      });
    });
  });

  // Cerrar modal con ESC
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") {
      cerrarModalPin();
    }
  });
</script>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif;
    background: #f4f6fb;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .demo-btn {
    background: #5d5fef;
    color: white;
    border: none;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .demo-btn:hover {
    background: #4a4cd9;
    transform: translateY(-2px);
  }

  /* MODAL PIN */
  .modal-pin {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    justify-content: center;
    align-items: center;
    z-index: 10000;
    padding: 1rem;
  }

  .modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.3);
  }

  .modal-content-pin {
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    position: relative;
    z-index: 1;
    max-width: 380px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header-pin {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 2rem 2rem 1rem;
    position: relative;
  }

  .modal-icon-pin {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    font-size: 1.5rem;
    flex-shrink: 0;
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    color: #0369a1;
  }

  .modal-title-pin {
    color: #1e2d70;
    font-size: 1.3rem;
    font-weight: 700;
    flex: 1;
    line-height: 1.3;
  }

  .modal-close-pin {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #666;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
  }

  .modal-close-pin:hover {
    background: #f4f6fb;
    color: #dc2626;
  }

  .modal-body-pin {
    padding: 0 2rem 1rem;
  }

  .modal-footer-pin {
    padding: 1rem 2rem 2rem;
    display: flex;
    gap: 0.75rem;
  }

  .pin-instruction {
    text-align: center;
    color: #666;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
  }

  .pin-error {
    background: #fef2f2;
    color: #dc2626;
    padding: 0.75rem 1rem;
    border-radius: 10px;
    border: 1px solid #fecaca;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .pin-container {
    display: flex;
    justify-content: center;
    gap: 0.75rem;
    margin: 2rem 0;
  }

  .pin-digit {
    width: 60px;
    height: 60px;
    text-align: center;
    font-size: 1.5rem;
    font-weight: 700;
    border: 2px solid #e8ecf7;
    border-radius: 12px;
    background: #f4f6fb;
    color: #1e2d70;
    transition: all 0.2s ease;
    outline: none;
  }

  .pin-digit:focus {
    border-color: #5d5fef;
    background: #fff;
    box-shadow: 0 0 0 4px rgba(93, 95, 239, 0.1);
  }

  .pin-digit.error {
    border-color: #dc2626;
    background: #fef2f2;
    animation: shake 0.5s ease-in-out;
  }

  @keyframes shake {
    0%,
    100% {
      transform: translateX(0);
    }
    25% {
      transform: translateX(-5px);
    }
    75% {
      transform: translateX(5px);
    }
  }

  .security-info {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    color: #666;
    font-size: 0.8rem;
    margin-top: 1rem;
  }

  .btn-modal-pin {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    border: none;
    border-radius: 12px;
    padding: 0.9rem 1.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    background: #5d5fef;
    color: #fff;
  }

  .btn-modal-pin:hover {
    background: #4a4cd9;
    transform: translateY(-1px);
  }
  #modal-loader-pin {
  z-index: 999999 !important;
}

#modal-loader-pin .modal-content {
  background: #fff;
  padding: 2rem 1.5rem;
  border-radius: 16px;
  max-width: 400px;
  width: 90%;
  text-align: center;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  position: relative;
  margin: 1rem;
}

#modal-loader-pin .modal-icon-container {
  display: flex;
  justify-content: center;
  margin-bottom: 1rem;
  gap: 1rem;
  align-items: center;
}

#modal-loader-pin .modal-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
  font-weight: bold;
  border: 2px solid #5d5fef;
  color: #5d5fef;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  animation: spin 1.2s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

#loader-title {
  color: #1f2937;
  font-size: 1.25rem;
  font-weight: 600;
  line-height: 1.4;
  margin: 0;
}

#loader-text {
  color: #4b5563;
  margin-top: 0.75rem;
  line-height: 1.5;
  font-size: 0.95rem;
}

@media (max-width: 480px) {
  #modal-loader-pin .modal-content {
    margin: 1rem 0.5rem;
    padding: 1.5rem 1rem;
  }
  #modal-loader-pin .modal-icon {
    width: 50px;
    height: 50px;
    font-size: 1.5rem;
  }
  #loader-title {
    font-size: 1.1rem;
  }
  #loader-text {
    font-size: 0.9rem;
  }
}

#modal-loader-transaccion {
  z-index: 999999 !important;
  display: flex;
  justify-content: center;
  align-items: center;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
}

#modal-loader-transaccion .modal-content {
  background: #fff;
  padding: 2rem 1.5rem;
  border-radius: 16px;
  max-width: 400px;
  width: 90%;
  text-align: center;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  position: relative;
  margin: 1rem;
}

#modal-loader-transaccion .modal-icon-container {
  display: flex;
  justify-content: center;
  margin-bottom: 1rem;
  gap: 1rem;
  align-items: center;
}

#modal-loader-transaccion .modal-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
  font-weight: bold;
  border: 2px solid #5d5fef;
  color: #5d5fef;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  animation: spin 1.2s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

#loader-title-transaccion {
  color: #1f2937;
  font-size: 1.25rem;
  font-weight: 600;
  line-height: 1.4;
  margin: 0;
}

#loader-text-transaccion {
  color: #4b5563;
  margin-top: 0.75rem;
  line-height: 1.5;
  font-size: 0.95rem;
}

@media (max-width: 480px) {
  #modal-loader-transaccion .modal-content {
    margin: 1rem 0.5rem;
    padding: 1.5rem 1rem;
  }
  #modal-loader-transaccion .modal-icon {
    width: 50px;
    height: 50px;
    font-size: 1.5rem;
  }
  #loader-title-transaccion {
    font-size: 1.1rem;
  }
  #loader-text-transaccion {
    font-size: 0.9rem;
  }
}


  /* RESPONSIVE */
  @media (max-width: 500px) {
    .modal-content-pin {
      margin: 1rem;
      max-width: none;
    }

    .modal-header-pin,
    .modal-body-pin,
    .modal-footer-pin {
      padding-left: 1.5rem;
      padding-right: 1.5rem;
    }

    .pin-digit {
      width: 50px;
      height: 50px;
      font-size: 1.3rem;
    }
  }
</style>