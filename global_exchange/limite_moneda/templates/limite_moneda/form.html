{% extends "base_forms.html" %}
{% load widget_tweaks %}

{% block form_title %}Configurar L√≠mite Global de Transacciones{% endblock %}

{% block form_fields %}

<!-- L√≠mite Diario -->
<div class="form-group">
  <label for="{{ form.limite_diario.id_for_label }}">L√≠mite Diario *</label>
  <div class="input-wrapper">
    <span class="icon">üìÖ</span>
    {{ form.limite_diario|add_class:"custom-input" }}
  </div>
  <span class="error-msg" id="error-diario"></span>
</div>

<!-- L√≠mite Mensual -->
<div class="form-group">
  <label for="{{ form.limite_mensual.id_for_label }}">L√≠mite Mensual *</label>
  <div class="input-wrapper">
    <span class="icon">üóìÔ∏è</span>
    {{ form.limite_mensual|add_class:"custom-input" }}
  </div>
  <span class="error-msg" id="error-mensual"></span>
</div>

<!-- Moneda (solo lectura) -->
<div class="form-group">
  <label>Moneda Base</label>
  <div class="input-wrapper">
    <span class="icon">üí±</span>
    <input type="text" class="custom-input" value="{{ form.instance.moneda.nombre }}" readonly>
    <!-- Hidden input para enviar el ID de la moneda -->
    <input type="hidden" name="moneda" value="{{ form.instance.moneda.id }}">
  </div>
</div>


<input type="hidden" id="obj_id" name="obj_id" value="{{ obj_id|default:'' }}">

<style>
.form-group {
  margin-bottom: 16px;
}

.form-group:last-of-type {
  margin-bottom: 0;
}

.input-wrapper {
  position: relative;
  display: block;
}

.input-wrapper .icon {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 16px;
  color: #5d5fef;
}

.custom-input {
  width: 100%;
  padding: 10px 10px 10px 40px;
  border-radius: 6px;
  border: 1px solid #d1d5db;
  background-color: #f0edff;
  font-size: 14px;
  box-sizing: border-box;
}

.custom-input:focus {
  border-color: #5d5fef;
  outline: none;
}

.custom-input.error {
  border-color: #ef4444;
  background-color: #fef2f2;
}

.custom-input.valid {
  border-color: #10b981;
  background-color: #f0fdf4;
}

.custom-input[readonly] {
  background-color: #f9fafb;
  cursor: not-allowed;
}

.error-msg {
  display: block;
  color: #ef4444;
  font-size: 12px;
  margin-top: 4px;
  min-height: 16px;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
$(document).ready(function() {
    const diarioInput = $('#id_limite_diario');
    const mensualInput = $('#id_limite_mensual');
    const errorDiario = $('#error-diario');
    const errorMensual = $('#error-mensual');

    function validarMonto(value) {
        // Validar obligatorio
        if (!value || value.trim() === '') {
            return 'Este campo es obligatorio';
        }
        
        // Limpiar el valor
        const valorLimpio = value.trim().replace(',', '.');
        
        // Validar que sea un n√∫mero
        const num = parseFloat(valorLimpio);
        if (isNaN(num)) {
            return 'Debe ingresar un n√∫mero v√°lido';
        }
        
        // Validar que no sea negativo
        if (num < 0) {
            return 'El valor no puede ser negativo';
        }
        
        // Validar formato: m√°ximo 15 enteros y 8 decimales
        const partes = valorLimpio.split('.');
        const enteros = partes[0].replace('-', ''); // Quitar signo si existe
        
        if (enteros.length > 15) {
            return 'M√°ximo 15 d√≠gitos enteros permitidos';
        }
        
        if (partes.length > 1 && partes[1].length > 8) {
            return 'M√°ximo 8 decimales permitidos';
        }
        
        return null; // Sin errores
    }

    function validarDiario() {
        const error = validarMonto(diarioInput.val());
        if (error) {
            diarioInput.addClass('error').removeClass('valid');
            errorDiario.text(error);
            return false;
        } else {
            diarioInput.addClass('valid').removeClass('error');
            errorDiario.text('');
            return true;
        }
    }

    function validarMensual() {
        const error = validarMonto(mensualInput.val());
        if (error) {
            mensualInput.addClass('error').removeClass('valid');
            errorMensual.text(error);
            return false;
        }
        
        const diario = parseFloat(diarioInput.val().replace(',', '.')) || 0;
        const mensual = parseFloat(mensualInput.val().replace(',', '.')) || 0;
        
        if (mensual < diario) {
            mensualInput.addClass('error').removeClass('valid');
            errorMensual.text('Debe ser mayor o igual al l√≠mite diario');
            return false;
        }
        
        mensualInput.addClass('valid').removeClass('error');
        errorMensual.text('');
        return true;
    }

    // Validar al salir del campo
    diarioInput.on('blur', function() {
        validarDiario();
        if (mensualInput.val()) validarMensual();
    });

    mensualInput.on('blur', validarMensual);

    // Validaci√≥n al enviar el formulario
    $('#form-accion').on('submit', function(e) {
        const validoDiario = validarDiario();
        const validoMensual = validarMensual();
            
        console.log('Validaci√≥n submit:', {
            diario: validoDiario,
            mensual: validoMensual,
            valorDiario: diarioInput.val(),
            valorMensual: mensualInput.val()
        });
        
        if (!validoDiario || !validoMensual) {
            e.preventDefault();
            console.log('Formulario inv√°lido - submit bloqueado');
            return false;
        }
        
        // Normalizar valores antes de enviar
        if (diarioInput.val()) {
            diarioInput.val(diarioInput.val().replace(',', '.'));
        }
        if (mensualInput.val()) {
            mensualInput.val(mensualInput.val().replace(',', '.'));
        }
        
        console.log('Formulario v√°lido - enviando...');
        return true; // Permitir submit normal
    });
});
</script>

{% endblock %}