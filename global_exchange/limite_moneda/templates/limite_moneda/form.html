{% extends "base_forms.html" %} 
{% load widget_tweaks %}

{% block form_title %}Agregar L√≠mite de Transacci√≥n{% endblock %}

{% block form_fields %}

<div class="form-group">
  <label for="{{ form.cliente.id_for_label }}">Cliente *</label>
  <div class="input-icon">
    <span class="icon">üë§</span>
    <select name="cliente" id="id_cliente" class="custom-input">
      <option value="">Seleccione un cliente...</option>
    </select>
  </div>
  <div class="error-messages"></div>
</div>

<div class="form-group">
  <label for="{{ form.moneda.id_for_label }}">Moneda *</label>
  <div class="input-icon">
    <span class="icon">üí∞</span>
    <select name="moneda" id="id_moneda" class="custom-input">
      <option value="">Seleccione una moneda...</option>
    </select>
  </div>
  <div class="error-messages"></div>
</div>

<div class="form-group">
  <label for="{{ form.limite_diario.id_for_label }}">L√≠mite Diario *</label>
  <div class="input-icon">
    <span class="icon">üìÖ</span>
    {{ form.limite_diario|add_class:"custom-input monto-field" }}
  </div>
  <div class="error-messages"></div>
</div>

<div class="form-group">
  <label for="{{ form.limite_mensual.id_for_label }}">L√≠mite Mensual *</label>
  <div class="input-icon">
    <span class="icon">üóìÔ∏è</span>
    {{ form.limite_mensual|add_class:"custom-input monto-field" }}
  </div>
  <div class="error-messages"></div>
</div>

<input type="hidden" id="obj_id" name="obj_id" value="{{ obj_id|default:'' }}">

<style>
.custom-input {
  width: 100%;
  padding: 8px 12px 8px 36px;
  border-radius: 6px;
  border: 1px solid #d1d5db;
  background-color: #f0edff;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.custom-input::placeholder { color: #6b7280; }
.custom-input:focus { border-color: #5d5fef; box-shadow: 0 0 0 3px rgba(93, 95, 239, 0.1); }
.custom-input.error { border-color: #ef4444 !important; background-color: #fef2f2; }
.custom-input.valid { border-color: #10b981; background-color: #f0fdf4; }
.input-icon { position: relative; margin-bottom: 4px; }
.input-icon .icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; font-size: 16px; color: #5d5fef; z-index: 1; }
.error-messages { min-height: 18px; margin-bottom: 8px; display: block; }
.error-messages .error-message { color: #ef4444; font-size: 12px; margin: 2px 0; display: block; line-height: 1.4; animation: slideDown 0.3s ease-out; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

.custom-input.loading {
  background-color: #f3f4f6;
  color: #6b7280;
}
.custom-input:disabled {
  cursor: not-allowed;
  opacity: 0.6;
}

select.custom-input.error { box-shadow: none; }

/* Resaltar el campo cuando se est√° aplicando redondeo */
.custom-input.rounding {
  background-color: #fef3c7;
  border-color: #f59e0b;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>

<script>
let limiteValidator = null;
let clientesLoaded = false;
let monedasLoaded = false;

jQuery.extend(jQuery.validator.messages, {
    required: "Este campo es obligatorio.",
    number: "Ingrese un n√∫mero v√°lido.",
    min: jQuery.validator.format("El valor no puede ser menor a {0}."),
    minlength: jQuery.validator.format("Por favor, no escribas menos de {0} caracteres."),
    maxlength: jQuery.validator.format("Por favor, no escribas m√°s de {0} caracteres.")
});

// Funci√≥n para validar y formatear montos
function validarYFormatearMonto(valor) {
    // Remover caracteres no num√©ricos excepto punto decimal
return  valor.replace(/[^0-9.]/g, '');
}


// Funci√≥n para manejar el formato en tiempo real
function setupMontoFormatting() {
    $('.monto-field').on('input', function() {
        const $this = $(this);
        const valorOriginal = $this.val();
        const valorFormateado = validarYFormatearMonto(valorOriginal);
        
        if (valorFormateado === null) {
            // Error: demasiados d√≠gitos enteros
            $this.addClass('error');
            const errorMsg = 'El monto no puede tener m√°s de 15 d√≠gitos enteros';
            const $errorContainer = $this.closest('.form-group').find('.error-messages');
            $errorContainer.html('<div class="error-message">' + errorMsg + '</div>');
        } else if (valorFormateado !== valorOriginal) {
            // Aplicar redondeo visual
            $this.addClass('rounding');
            setTimeout(() => {
                $this.val(valorFormateado);
                $this.removeClass('rounding');
            }, 200);
        }
    });

    $('.monto-field').on('blur', function() {
        const $this = $(this);
        const valor = $this.val();
        const valorFormateado = validarYFormatearMonto(valor);
        
        if (valorFormateado !== null && valorFormateado !== valor) {
            $this.val(valorFormateado);
        }
        
        // Limpiar clases visuales
        $this.removeClass('rounding');
    });
}

// M√©todo personalizado de validaci√≥n para montos
jQuery.validator.addMethod("validMonto", function(value, element) {
    if (!value) return true; // Lo maneja required
    
    const valorFormateado = validarYFormatearMonto(value);
    
    if (valorFormateado === null) {
        return false; // Demasiados d√≠gitos enteros
    }
    
    // Verificar formato final
    const numero = parseFloat(valorFormateado);
    if (isNaN(numero) || numero < 0) {
        return false;
    }
    
    // Validar estructura: m√°ximo 15 enteros y 8 decimales
    const partes = valorFormateado.split('.');
    const parteEntera = partes[0] || '0';
    const parteDecimal = partes[1] || '';
    
    return parteEntera.length <= 15 && parteDecimal.length <= 8;
}, "El monto debe tener m√°ximo 15 d√≠gitos enteros y 8 decimales");

// M√©todo personalizado para validar que l√≠mite mensual sea mayor o igual al diario
jQuery.validator.addMethod("limiteMensualMayor", function(value, element) {
    if (!value) return true; // Lo maneja required
    
    const limiteDiario = parseFloat($('#id_limite_diario').val()) || 0;
    const limiteMensual = parseFloat(value) || 0;
    
    // El l√≠mite mensual debe ser mayor o igual al l√≠mite diario
    return limiteMensual >= limiteDiario;
}, "El l√≠mite mensual debe ser mayor o igual al l√≠mite diario");

// Cargar clientes y mantener selecci√≥n si existe
function loadClientes(selectedId = null) {
    if (clientesLoaded && !selectedId) {
        console.log("Clientes ya cargados, saltando...");
        return Promise.resolve();
    }
    
    const $clienteSelect = $('#id_cliente');
    $clienteSelect.prop('disabled', true).addClass('loading');

    return $.ajax({
        url: '{% url "get_clientes" %}',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
            console.log("Cargando clientes, selectedId:", selectedId);
            $clienteSelect.empty().append('<option value="">Seleccione un cliente...</option>');
            
            $.each(data, function(i, cliente) {
                const option = $('<option></option>')
                    .val(cliente.id)
                    .text(cliente.nombre + (cliente.cedula ? ' (' + cliente.cedula + ')' : ''));
                
                // Marcar como seleccionado si coincide
                if (selectedId && cliente.id == selectedId) {
                    option.prop('selected', true);
                    console.log("Cliente seleccionado:", cliente.nombre);
                }
                
                $clienteSelect.append(option);
            });
            clientesLoaded = true;
        },
        error: function() {
            $clienteSelect.empty().append('<option value="">Error cargando clientes</option>');
        },
        complete: function() {
            $clienteSelect.prop('disabled', false).removeClass('loading');
        }
    });
}

// Cargar monedas y mantener selecci√≥n si existe  
function loadMonedas(selectedId = null) {
    if (monedasLoaded && !selectedId) {
        console.log("Monedas ya cargadas, saltando...");
        return Promise.resolve();
    }
    
    const $monedaSelect = $('#id_moneda');
    $monedaSelect.prop('disabled', true).addClass('loading');

    return $.ajax({
        url: '{% url "get_monedas" %}',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
            console.log("Cargando monedas, selectedId:", selectedId);
            $monedaSelect.empty().append('<option value="">Seleccione una moneda...</option>');
            
            $.each(data, function(i, moneda) {
                const option = $('<option></option>')
                    .val(moneda.id)
                    .text(moneda.nombre + ' (' + moneda.abreviacion + ')');
                
                // Marcar como seleccionado si coincide
                if (selectedId && moneda.id == selectedId) {
                    option.prop('selected', true);
                    console.log("Moneda seleccionada:", moneda.nombre);
                }
                
                $monedaSelect.append(option);
            });
            monedasLoaded = true;
        },
        error: function() {
            $monedaSelect.empty().append('<option value="">Error cargando monedas</option>');
        },
        complete: function() {
            $monedaSelect.prop('disabled', false).removeClass('loading');
        }
    });
}

// Capturar valores actuales antes de recargar
function getCurrentValues() {
    return {
        cliente: $('#id_cliente').val(),
        moneda: $('#id_moneda').val(),
        limite_diario: $('#id_limite_diario').val(),
        limite_mensual: $('#id_limite_mensual').val()
    };
}

// Restaurar valores despu√©s de recargar selects
function restoreValues(values) {
    console.log("Restaurando valores:", values);
    if (values.cliente) $('#id_cliente').val(values.cliente);
    if (values.moneda) $('#id_moneda').val(values.moneda);
    if (values.limite_diario) $('#id_limite_diario').val(values.limite_diario);
    if (values.limite_mensual) $('#id_limite_mensual').val(values.limite_mensual);
}

// Funci√≥n para revalidar l√≠mites cuando cambien
function revalidarLimites() {
    if (limiteValidator) {
        $('#id_limite_diario').valid();
        $('#id_limite_mensual').valid();
    }
}

// Validaci√≥n de formulario
function setupLimiteValidation() {
    const $form = $("#form-accion");
    if (!$form.length) {
        console.log("Formulario no encontrado");
        return null;
    }

    if (limiteValidator) { 
        limiteValidator.destroy(); 
        limiteValidator = null; 
    }

    console.log("Configurando validaci√≥n del formulario l√≠mites");

    limiteValidator = $form.validate({
        rules: {
            cliente: { required: true },
            moneda: { 
                required: true,
                remote: {
                    url: '{% url "check-nombre-cliente" %}',
                    type: "post",
                    data: {
                        cliente: function() {
                            return $("#id_cliente").val();
                        },
                        moneda: function() {
                            return $("#id_moneda").val();
                        },
                        obj_id: function() {
                            // Buscar en m√∫ltiples ubicaciones posibles
                            let objId = $("#obj_id").val() || 
                                       $("input[name='obj_id']").val() || 
                                       $("#form-accion").attr('data-obj-id') ||
                                       $("#form-accion").data('obj-id');
                            
                            console.log("üîç Verificando modo edici√≥n - obj_id:", objId, "tipo:", typeof objId);
                            
                            // Verificar si es string vac√≠o
                            if (objId === '' || objId === 'undefined' || objId === 'null') {
                                console.log("‚ö†Ô∏è obj_id vac√≠o o inv√°lido, modo CREACI√ìN");
                                return null;
                            }
                            
                            if (objId && objId !== '') {
                                console.log("‚úÖ Modo EDICI√ìN - obj_id:", objId);
                                return objId;
                            }
                            
                            console.log("‚ùå obj_id no encontrado, modo CREACI√ìN por defecto");
                            return null;
                        },
                        csrfmiddlewaretoken: function() {
                            return $("input[name='csrfmiddlewaretoken']").val();
                        }
                    },
                    beforeSend: function(xhr, settings) {
                        console.log("Enviando validaci√≥n remota:", settings.data);
                    }
                }
            },
            limite_diario: { 
                required: true, 
                validMonto: true,
                min: 0 
            },
            limite_mensual: { 
                required: true, 
                validMonto: true,
                min: 0,
                limiteMensualMayor: true
            }
        },
        messages: {
            cliente: { required: "Seleccione un cliente" },
            moneda: { 
                required: "Seleccione una moneda",
                remote: "Este cliente ya tiene un l√≠mite activo para esta moneda."
            },
            limite_diario: { 
                required: "Ingrese l√≠mite diario", 
                validMonto: "M√°ximo 15 d√≠gitos enteros y 8 decimales",
                min: "No puede ser negativo" 
            },
            limite_mensual: { 
                required: "Ingrese l√≠mite mensual", 
                validMonto: "M√°ximo 15 d√≠gitos enteros y 8 decimales",
                min: "No puede ser negativo",
                limiteMensualMayor: "El l√≠mite mensual debe ser mayor o igual al l√≠mite diario"
            }
        },
        errorElement: 'div',
        errorClass: 'error-message',
        validClass: 'valid',
        errorPlacement: function(error, element) {
            console.log("Colocando error:", error.text(), "para elemento:", element.attr('name'));
            let formGroup = element.closest('.form-group');
            let errorContainer = formGroup.find('.error-messages');
            if (!errorContainer.length) {
                errorContainer = $('<div class="error-messages"></div>').appendTo(formGroup);
            }
            errorContainer.html(error);
        },
        highlight: function(element) { 
            $(element).addClass('error').removeClass('valid');
            console.log("Marcando campo con error:", $(element).attr('name'));
        },
        unhighlight: function(element) { 
            $(element).removeClass('error').addClass('valid');
            console.log("Limpiando error de campo:", $(element).attr('name'));
        },
        success: function(label, element) {
            console.log("Campo v√°lido:", $(element).attr('name'));
            $(element).closest('.form-group').find('.error-messages').empty();
        },
        submitHandler: function(form) {
            console.log("üöÄ SubmitHandler ejecutado");
            
            // Formatear montos antes del env√≠o final
            const limitesDiario = $('#id_limite_diario').val();
            const limitesMensual = $('#id_limite_mensual').val();
            
            if (limitesDiario) {
                const diarioFormateado = validarYFormatearMonto(limitesDiario);
                if (diarioFormateado !== null) {
                    $('#id_limite_diario').val(diarioFormateado);
                }
            }
            
            if (limitesMensual) {
                const mensualFormateado = validarYFormatearMonto(limitesMensual);
                if (mensualFormateado !== null) {
                    $('#id_limite_mensual').val(mensualFormateado);
                }
            }
            
            // Verificar obj_id antes del env√≠o
            const objId = $("#obj_id").val();
            console.log("üìù SubmitHandler - obj_id:", objId, "tipo:", typeof objId);
            
            if (objId && objId !== '' && objId !== 'undefined' && objId !== 'null') {
                console.log("‚úèÔ∏è Modo EDICI√ìN - obj_id:", objId);
            } else {
                console.log("‚ûï Modo CREACI√ìN - validando duplicados antes del env√≠o");
            }
            
            // Proceder con el env√≠o
            console.log("üì§ Enviando formulario...");
            form.submit();
        },
        invalidHandler: function(event, validator) {
            console.log("Formulario inv√°lido, errores:", validator.numberOfInvalids());
        }
    });

    // Configurar eventos para revalidaci√≥n en tiempo real
    $('#id_limite_diario, #id_limite_mensual').on('blur keyup', function() {
        // Peque√±o delay para permitir que el formateo termine
        setTimeout(revalidarLimites, 100);
    });

    return limiteValidator;
}

// Sobrescribir funciones del modal
$(document).ready(function() {
    // Configurar formato de montos
    setupMontoFormatting();
    
    // Cargar datos iniciales
    loadClientes();
    loadMonedas();
    setupLimiteValidation();

    // Guardar funciones originales
    const originalOpenCreateModal = window.openCreateModal;
    const originalOpenEditModal = window.openEditModal;
    const originalCloseModal = window.closeModal;

    // Nueva funci√≥n para crear modal
    window.openCreateModal = function(createUrl, title) {
        console.log("Abriendo modal crear l√≠mite");
        
        if (originalOpenCreateModal) {
            originalOpenCreateModal(createUrl, title);
        }
        
        setTimeout(function() {
            // Para crear, solo necesitamos asegurar que los selects est√©n cargados
            Promise.all([
                loadClientes(),
                loadMonedas()
            ]).then(() => {
                setupLimiteValidation();
                setupMontoFormatting();
            });
        }, 200);
    };

    // Nueva funci√≥n para editar modal - CON MANEJO CORRECTO
    window.openEditModal = function(id, editUrl, detalle, title) {
        console.log("üöÄ Abriendo modal editar l√≠mite, ID recibido:", id, "tipo:", typeof id);
        
        if (originalOpenEditModal) {
            originalOpenEditModal(id, editUrl, detalle, title);
        }
        
        // Funci√≥n para verificar y configurar el modal
        function configurarModalEdicion() {
            console.log("‚öôÔ∏è Configurando modal de edici√≥n...");
            
            // 1. FORZAR actualizaci√≥n del obj_id inmediatamente
            const objIdField = $("#obj_id");
            objIdField.val(id);
            console.log("üìù obj_id forzado a:", objIdField.val(), "campo existe:", objIdField.length);
            
            // 2. Verificar que el campo tenga el valor correcto
            const objIdValue = objIdField.val();
            console.log("üîç Verificando obj_id final:", objIdValue, "tipo:", typeof objIdValue);
            
            if (!objIdValue || objIdValue === '') {
                console.error("‚ùå ERROR: obj_id sigue vac√≠o despu√©s de asignaci√≥n");
                // Intentar otra vez con diferentes m√©todos
                $("input[name='obj_id']").val(id);
                $("#form-accion").attr('data-obj-id', id);
                console.log("üîÑ Reintento - obj_id:", $("#obj_id").val());
            }
            
            // 3. Capturar valores actuales
            const currentValues = getCurrentValues();
            console.log("üìä Valores actuales capturados:", currentValues);
            
            // 4. Recargar selects manteniendo la selecci√≥n
            Promise.all([
                loadClientes(currentValues.cliente),
                loadMonedas(currentValues.moneda)
            ]).then(() => {
                // 5. Restaurar valores por si se perdieron
                restoreValues(currentValues);
                
                // 6. VERIFICAR NUEVAMENTE obj_id antes de configurar validaci√≥n
                const finalObjId = $("#obj_id").val();
                console.log("üéØ obj_id antes de configurar validaci√≥n:", finalObjId);
                
                if (!finalObjId || finalObjId === '') {
                    console.error("‚ö†Ô∏è ADVERTENCIA: Configurando validaci√≥n sin obj_id v√°lido");
                }
                
                // 7. Configurar validaci√≥n y formato
                setupLimiteValidation();
                setupMontoFormatting();
                
                console.log("‚úÖ Modal de edici√≥n configurado correctamente");
            }).catch((error) => {
                console.error("‚ùå Error configurando modal:", error);
            });
        }
        
        // Intentar m√∫ltiples veces con diferentes timeouts
        setTimeout(configurarModalEdicion, 800);
        setTimeout(configurarModalEdicion, 1500);
    };

    // Nueva funci√≥n para cerrar modal
    window.closeModal = function() {
        console.log("Cerrando modal l√≠mite");
        
        // Limpiar validaci√≥n
        if (limiteValidator) {
            limiteValidator.destroy();
            limiteValidator = null;
        }
        
        // Limpiar clases y mensajes
        $("#form-accion .error").removeClass('error');
        $("#form-accion .valid").removeClass('valid');
        $("#form-accion .rounding").removeClass('rounding');
        $(".error-messages").empty();
        
        // Reset flags para permitir recarga en pr√≥xima apertura
        clientesLoaded = false;
        monedasLoaded = false;
        
        if (originalCloseModal) {
            originalCloseModal();
        }
    };

    console.log("Sistema de validaci√≥n de l√≠mites inicializado");
});


</script>

{% endblock %}