{% extends "base_forms.html" %} 

{% load widget_tweaks %} 

{% block form_title %}Agregar Cliente{% endblock %} 

{% block form_fields %}
<div class="form-group">
  <label for="{{ form.nombre.id_for_label }}">Nombre *</label>
  <div class="input-icon">
    <span class="icon">üë§</span>
    {{ form.nombre|add_class:"custom-input" }}
  </div>
  <div class="error-messages"></div>
</div>

<div class="form-group">
  <label for="{{ form.email.id_for_label }}">Email *</label>
  <div class="input-icon">
    <span class="icon">üìß</span>
    {{ form.email|add_class:"custom-input" }}
  </div>
  <div class="error-messages"></div>
</div>

<div class="form-group">
  <label for="{{ form.telefono.id_for_label }}">Tel√©fono *</label>
  <div class="input-icon">
    <span class="icon">üìû</span>
    {{ form.telefono|add_class:"custom-input" }}
  </div>
  <div class="error-messages"></div>
</div>

{% if form.instance.estado == "activo" %}
<div class="form-group">
  <label for="{{ form.segmentacion.id_for_label }}">Segmentaci√≥n *</label>
  <div class="input-icon">
    <span class="icon">üè∑Ô∏è</span>
    {{ form.segmentacion|add_class:"custom-input" }}
  </div>
  <div class="error-messages"></div>
</div>
{% endif %}

<div class="form-group">
  <label for="{{ form.estado.id_for_label }}">Estado *</label>
  <div class="input-icon">
    <span class="icon">‚ö°</span>
    {{ form.estado|add_class:"custom-input" }}
  </div>
  <div class="error-messages"></div>
</div>

<style>
  .custom-input {
    width: 100%;
    padding: 8px 12px 8px 36px;
    /* espacio para icono */
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background-color: #f0edff;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .custom-input::placeholder {
    color: #6b7280;
  }

  .custom-input:focus {
    border-color: #5d5fef;
    box-shadow: 0 0 0 3px rgba(93, 95, 239, 0.1);
  }

  /* Estilos para validaci√≥n */
  .custom-input.error {
    border-color: #ef4444 !important;
    background-color: #fef2f2;
  }

  .custom-input.valid {
    border-color: #10b981;
    background-color: #f0fdf4;
  }

  .input-icon {
    position: relative;
    margin-bottom: 4px;
  }

  .input-icon .icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    font-size: 16px;
    color: #5d5fef;
    z-index: 1;
  }

  .error-messages {
    min-height: 18px;
    margin-bottom: 8px;
    display: block;
  }

  .error-messages .error-message {
    color: #ef4444 !important;
    font-size: 12px !important;
    font-weight: normal !important;
    margin: 2px 0 !important;
    padding: 0 !important;
    display: block !important;
    background: none !important;
    border: none !important;
    text-align: left !important;
    line-height: 1.4 !important;
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<!-- jQuery Validate Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<script>
  // Variable global para el validador
  let clienteValidator = null;

  // Configurar mensajes en espa√±ol
  jQuery.extend(jQuery.validator.messages, {
    required: "Este campo es obligatorio.",
    email: "Por favor, escribe una direcci√≥n de correo v√°lida.",
    digits: "Por favor, escribe s√≥lo n√∫meros.",
    minlength: jQuery.validator.format("Por favor, no escribas menos de {0} caracteres."),
    maxlength: jQuery.validator.format("Por favor, no escribas m√°s de {0} caracteres.")
  });

  // Funci√≥n para inicializar validaci√≥n
  function setupClienteValidation() {
    const $form = $("#form-accion");

    if (!$form.length) {
      console.log("Formulario no encontrado");
      return null;
    }

    // Destruir validador existente si existe
    if (clienteValidator) {
      clienteValidator.destroy();
      clienteValidator = null;
    }

    console.log("Configurando validaci√≥n del formulario cliente");

    clienteValidator = $form.validate({
      rules: {
        nombre: {
          required: true,
          minlength: 2,
          maxlength: 100
        },
        email: {
          required: true,
          email: true,
          maxlength: 150,
          remote: {
            url: "/clientes/check-email/",
            type: "post",
            data: {
              email: function () {
                return $("#form-accion input[name='email']").val();
              },
              obj_id: function () {
                // Obtener directamente del campo que ya existe en tu modal
                let objId = $("#obj_id").val();

                console.log("obj_id encontrado para validaci√≥n:", objId);

                // Si est√° vac√≠o, devolver null para que sea tratado como creaci√≥n
                return (objId && objId !== '') ? objId : null;
              },
              csrfmiddlewaretoken: function () {
                return $("input[name='csrfmiddlewaretoken']").val();
              }
            },
            // Agregar callback para debug
            beforeSend: function (xhr, settings) {
              console.log("Enviando validaci√≥n remota:", settings.data);
            }
          }
        },
        telefono: {
          required: true,
          minlength: 8,
          digits: true,
          maxlength: 15
        },
        segmentacion: {
          required: true
        },
        estado: {
          required: true
        }
      },
      messages: {
        nombre: {
          required: "El nombre es obligatorio",
          minlength: "El nombre debe tener al menos 2 caracteres",
          maxlength: "El nombre no puede exceder 100 caracteres"
        },
        email: {
          required: "El email es obligatorio",
          email: "Ingrese un email v√°lido",
          maxlength: "El email no puede exceder 150 caracteres",
          remote: "Este email ya est√° en uso"
        },
        telefono: {
          required: "El tel√©fono es obligatorio",
          digits: "El tel√©fono debe contener solo n√∫meros",
          minlength: "El tel√©fono debe tener al menos 8 caracteres",
          maxlength: "El tel√©fono no puede exceder 15 caracteres"
        },
        segmentacion: {
          required: "Debe seleccionar una segmentaci√≥n"
        },
        estado: {
          required: "Debe seleccionar un estado"
        }
      },
      errorElement: 'div',
      errorClass: 'error-message',
      validClass: 'valid',
      errorPlacement: function (error, element) {
        console.log("Colocando error:", error.text(), "para elemento:", element.attr('name'));
        let formGroup = element.closest('.form-group');
        let errorContainer = formGroup.find('.error-messages');

        if (!errorContainer.length) {
          errorContainer = $('<div class="error-messages"></div>').appendTo(formGroup);
        }
        errorContainer.html(error);
      },
      highlight: function (element, errorClass, validClass) {
        $(element).addClass('error').removeClass(validClass);
        console.log("Marcando campo con error:", $(element).attr('name'));
      },
      unhighlight: function (element, errorClass, validClass) {
        $(element).removeClass('error').addClass(validClass);
        console.log("Limpiando error de campo:", $(element).attr('name'));
      },
      success: function (label, element) {
        console.log("Campo v√°lido:", $(element).attr('name'));
        $(element).closest('.form-group').find('.error-messages').empty();
      },
      submitHandler: function (form) {
        console.log("Formulario v√°lido, enviando...");
        form.submit();
      },
      invalidHandler: function (event, validator) {
        console.log("Formulario inv√°lido, errores:", validator.numberOfInvalids());
      }
    });
    $("#form-accion input[name='telefono']").on("input", function () {
      this.value = this.value.replace(/[^0-9]/g, ''); // solo n√∫meros
    });
    return clienteValidator;
  }

  // Sobrescribir funciones del modal para incluir validaci√≥n
  $(document).ready(function () {
    // Guardar funciones originales
    const originalOpenCreateModal = window.openCreateModal;
    const originalOpenEditModal = window.openEditModal;
    const originalCloseModal = window.closeModal;

    // Nueva funci√≥n para crear modal
    window.openCreateModal = function (createUrl, title) {
      console.log("Abriendo modal crear con validaci√≥n");

      if (originalOpenCreateModal) {
        originalOpenCreateModal(createUrl, title);
      }

      // Configurar validaci√≥n despu√©s de que el modal se abra
      setTimeout(function () {
        setupClienteValidation();
      }, 200);
    };

    // Nueva funci√≥n para editar modal
    window.openEditModal = function (id, editUrl, detalle, title) {
      console.log("Abriendo modal editar con validaci√≥n, ID:", id);

      if (originalOpenEditModal) {
        originalOpenEditModal(id, editUrl, detalle, title);
      }

      // Configurar validaci√≥n despu√©s de cargar datos
      setTimeout(function () {
        // Asegurar que el campo obj_id tenga el ID correcto
        const objIdField = $("#obj_id");
        if (objIdField.length) {
          objIdField.val(id);
          console.log("Campo obj_id actualizado con valor:", id);
        }

        setupClienteValidation();
      }, 1000); // Timeout m√°s largo para que el fetch termine
    };

    // Nueva funci√≥n para cerrar modal
    window.closeModal = function () {
      console.log("Cerrando modal y limpiando validaci√≥n");

      // Limpiar validaci√≥n
      if (clienteValidator) {
        clienteValidator.destroy();
        clienteValidator = null;
      }

      // Limpiar clases y mensajes manualmente
      $("#form-accion .error").removeClass('error');
      $("#form-accion .valid").removeClass('valid');
      $(".error-messages").empty();

      if (originalCloseModal) {
        originalCloseModal();
      }
    };

    console.log("Sistema de validaci√≥n de cliente inicializado");
  });
</script>

{% endblock %}