{% load static %}

<!-- Modal Crear/Editar -->
<div id="modal-accion" class="custom-modal">
  <div class="custom-modal-content">
    <form method="POST" id="form-accion" action="{{ form_action }}" novalidate>
      {% csrf_token %}
      <input
        type="hidden"
        name="obj_id"
        id="obj_id"
        value="{{ obj_id|default:'' }}"
      />

      <!-- Header -->
      <div class="modal-header">
        <h2 id="modal-title">{% block form_title %}{% endblock %}</h2>
        <button type="button" class="close-btn" onclick="closeModal()">
          &times;
        </button>
      </div>

      <!-- Body -->
      <div class="modal-body" id="form-fields-container">
        {% block form_fields %}{% endblock %}
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn-cancelar" onclick="closeModal()">
          Cancelar
        </button>
        <button type="submit" class="btn-confirmar">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Eliminar -->
<div id="modal-delete" class="custom-modal">
  <div class="custom-modal-content">
    <form method="POST" id="delete-form">
      {% csrf_token %}
      <input type="hidden" name="obj_id" id="delete_obj_id" />
      <p id="delete-message">¿Seguro que deseas eliminar este registro?</p>

      <div class="modal-footer">
        <button type="submit" class="btn-confirmar">Eliminar</button>
        <button type="button" class="btn-cancelar" onclick="closeModal()">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<style>
  .custom-modal {
    display: none;
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.4);
    justify-content: center;
    align-items: center;
    z-index: 1000;
    
  }
  .custom-modal-content {
    background: #fff;
    border-radius: 12px;
    width: 100%;
    max-width: 500px;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    animation: fadeIn 0.3s ease-in-out;
  }
  .modal-header {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 16px;
    position: relative;
  }
  .modal-header h2 {
    font-size: 20px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
  }
  .close-btn {
    position: absolute;
    right: 16px;
    top: 0;
    background: none;
    border: none;
    font-size: 26px;
    font-weight: bold;
    color: #6b7280;
    cursor: pointer;
  }
  .close-btn:hover {
    color: #ef4444;
    transform: scale(1.2);
  }
  .modal-body {
    display: flex;
    flex-direction: column;
    font-size: 14px;
    color: #374151;
  }
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 16px;
  }
  .btn-cancelar {
    background-color: #f3f4f6;
    color: #374151;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
  }
  .btn-cancelar:hover {
    background-color: #e5e7eb;
  }
  .btn-confirmar {
    background-color: #5d5fef;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
  }
  .btn-confirmar:hover {
    background-color: #4f46e5;
  }
  
  /* Estilos para los formularios */
  .form-group {
    margin-bottom: 5px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #374151;
  }
  
  .custom-input {
    width: 100%;
    padding: 8px 12px 8px 36px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background-color: #f0edff;
    font-size: 14px;
    outline: none;
    box-sizing: border-box;
  }
  
  .custom-input:focus {
    border-color: #5d5fef;
    box-shadow: 0 0 0 2px rgba(93, 95, 239, 0.1);
  }
  
  .custom-input.error {
    border-color: #ef4444;
    background-color: #fef2f2;
  }
  
  .custom-input::placeholder {
    color: #6b7280;
  }
  
  .input-icon {
    position: relative;
    margin-bottom: 5px;
  }
  
  .input-icon .icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    font-size: 16px;
    color: #5d5fef;
    z-index: 1;
  }
  
  .error-messages {
    margin-top: 4px;
  }
  
  .error-text {
    color: #ef4444;
    font-size: 13px;
    display: block;
    margin-bottom: 2px;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.9);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
</style>

<script>
  function openCreateModal(createUrl) {
    console.log("Opening create modal with URL:", createUrl);
    document.getElementById("form-accion").action = createUrl;
    document.getElementById("form-accion").reset();
    clearFormErrors();
    document.getElementById("modal-title").textContent = "Agregar Cliente";
    document.getElementById("modal-accion").style.display = "flex";
  }

  function openEditModal(id, editUrl, detalle) {
    const form = document.getElementById("form-accion");
    form.action = editUrl.replace("0", id);
    form.reset();
    clearFormErrors();

    fetch(detalle)
      .then((res) => res.json())
      .then((data) => {
        console.log(data);

        Object.entries(data).forEach(([key, value]) => {
          const fields = form.querySelectorAll(`[name="${key}"]`);
          if (!fields.length) return;

          fields.forEach((field) => {
            if (field.type === "checkbox") {
              if (Array.isArray(value)) {
                field.checked = value.includes(parseInt(field.value));
              } else {
                field.checked = !!value;
              }
            } else if (field.tagName === "SELECT" && field.multiple) {
              Array.from(field.options).forEach((opt) => {
                opt.selected = value.includes(parseInt(opt.value));
              });
            } else {
              field.value = value;
            }
          });
        });
      })
      .catch(error => {
        console.error("Error fetching details:", error);
      });

    document.getElementById("modal-title").textContent = "Editar Cliente";
    document.getElementById("modal-accion").style.display = "flex";
  }

  function openDeleteModal(
    id,
    deleteUrl,
    message = "¿Seguro que deseas eliminar este registro?"
  ) {
    document.getElementById("delete_obj_id").value = id;
    document.getElementById("delete-form").action = deleteUrl.replace("0", id);
    document.getElementById("delete-message").innerText = message;
    document.getElementById("modal-delete").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("modal-accion").style.display = "none";
    document.getElementById("modal-delete").style.display = "none";
    clearFormErrors();
  }

  function clearFormErrors() {
    // Remover mensajes de error
    const errorMessages = document.querySelectorAll(".error-messages");
    errorMessages.forEach((error) => error.remove());
    
    // Remover clases de error de los inputs
    const errorInputs = document.querySelectorAll(".custom-input.error");
    errorInputs.forEach((input) => input.classList.remove("error"));
  }

  // Event listeners para botones
  document.addEventListener("DOMContentLoaded", function () {
    // Botones de editar
    document.querySelectorAll(".btn-edit").forEach((btn) => {
      btn.addEventListener("click", () => {
        openEditModal(btn.dataset.id, btn.dataset.edit, btn.dataset.detalle);
      });
    });
    
    // Botones de eliminar
    document.querySelectorAll(".btn-delete").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.id;
        const deleteUrl = btn.dataset.delete.replace("0", id);
        openDeleteModal(id, deleteUrl);
      });
    });

    // Manejar envío del formulario principal
    const form = document.getElementById("form-accion");
    if (!form) return;

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      
      const url = form.action;
      const formData = new FormData(form);
      
      // Mostrar indicador de carga (opcional)
      const submitBtn = form.querySelector('.btn-confirmar');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Guardando...';
      submitBtn.disabled = true;

      fetch(url, {
        method: "POST",
        body: formData,
        headers: { 
          "X-Requested-With": "XMLHttpRequest",
        }
      })
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(data => {
        console.log("Response data:", data);
        
        if (data.success) {
          closeModal();
          location.reload(); // refresca la lista
        } else if (data.html_form) {
          // Crear un documento temporal para parsear el HTML
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = data.html_form;
          
          // Extraer solo el contenido del formulario (sin el template base)
          const formContent = tempDiv.querySelector('#form-fields-container') || tempDiv;
          
          // Reemplazar solo el contenido del cuerpo del modal
          const container = document.getElementById("form-fields-container");
          if (container && formContent) {
            container.innerHTML = formContent.innerHTML;
            
            // Marcar inputs con errores
            const errorFields = container.querySelectorAll('.error-messages');
            errorFields.forEach(errorDiv => {
              const fieldName = errorDiv.previousElementSibling?.querySelector('input, select')?.name;
              if (fieldName) {
                const input = container.querySelector(`[name="${fieldName}"]`);
                if (input) {
                  input.classList.add('error');
                }
              }
            });
          }
        } else {
          console.error("Respuesta inesperada:", data);
          alert("Error inesperado. Por favor intente nuevamente.");
        }
      })
      .catch(err => {
        console.error("Error AJAX:", err);
        alert("Error de conexión. Por favor intente nuevamente.");
      })
      .finally(() => {
        // Restaurar botón
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      });
    });
  });
</script>