{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
  <!-- jQuery (debe ir primero) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta charset="UTF-8">
</head>

</html>

<!-- Modal Crear/Editar -->
<div id="modal-accion" class="custom-modal">
  <div class="custom-modal-content">
    <form method="POST" id="form-accion" action="{{ form_action }}">
      {% csrf_token %}
      <input type="hidden" name="obj_id" id="obj_id" value="{{ obj_id|default:'' }}" />

      <!-- Header -->
      <div class="modal-header">
        <h2 id="modal-title">{% block form_title %}{% endblock %}</h2>
        <button type="button" class="close-btn" onclick="closeModal()">
          &times;
        </button>
      </div>

      <!-- Body -->
      <div class="modal-body" id="form-fields-container">
        {% block form_fields %}{% endblock %}
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn-cancelar" onclick="closeModal()">
          Cancelar
        </button>
        <button type="submit" class="btn-confirmar">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Eliminar -->
<div id="modal-delete" class="custom-modal">
  <div class="custom-modal-content">
    <form method="POST" id="delete-form">
      {% csrf_token %}
      <input type="hidden" name="obj_id" id="delete_obj_id" />
      <p id="delete-message">¿Seguro que deseas desactivar este registro?</p>
      <div class="modal-footer">
        <button type="submit" class="btn-confirmar">Desactivar</button>
        <button type="button" class="btn-cancelar" onclick="closeModal()">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<style>
  .custom-modal {
    display: none;
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.4);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .custom-modal-content {
    background: #fff;
    border-radius: 12px;
    width: 100%;
    max-width: 500px;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    animation: fadeIn 0.3s ease-in-out;
  }

  .modal-header {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 16px;
    position: relative;
  }

  .modal-header h2 {
    font-size: 20px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
  }

  .close-btn {
    position: absolute;
    right: 16px;
    top: 0;
    background: none;
    border: none;
    font-size: 26px;
    font-weight: bold;
    color: #6b7280;
    cursor: pointer;
    z-index: 100;
  }

  .close-btn:hover {
    color: #ef4444;
    transform: scale(1.2);
  }

  .modal-body {
    display: flex;
    flex-direction: column;
    gap: 12px;
    font-size: 14px;
    color: #374151;
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 16px;
  }

  .btn-cancelar {
    background-color: #f3f4f6;
    color: #374151;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
  }

  .btn-cancelar:hover {
    background-color: #e5e7eb;
  }

  .btn-confirmar {
    background-color: #5d5fef;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
  }

  .btn-confirmar:hover {
    background-color: #4f46e5;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.9);
    }

    to {
      opacity: 1;
      transform: scale(1);
    }
  }
</style>

<script>

  function openCreateModal(createUrl, model_title) {
    console.log("URL:", createUrl);
    console.log("Titulo:", model_title);
    document.getElementById("form-accion").action = createUrl;
    document.getElementById("form-accion").reset();

    clearFormErrors();
    document.getElementById("modal-title").textContent = model_title;

    // --- RESET DUAL LISTBOX ---
    const available = document.getElementById("available-perms");
    const selected = document.getElementById("selected-perms");
    if (available && selected) {
      // Mover todos los options de selected a available
      const allOptions = [];
      Array.from(available.options).forEach(opt => allOptions.push(opt));
      Array.from(selected.options).forEach(opt => allOptions.push(opt));
      available.innerHTML = "";
      selected.innerHTML = "";
      allOptions.forEach(opt => {
        opt.selected = false;
        available.appendChild(opt);
      });
    }
    // --- FIN RESET DUAL LISTBOX ---
    document.getElementById("modal-accion").style.display = "flex";

    const modalTitle = document.getElementById("modal-title");
    modalTitle.textContent = model_title;
  }

  function openEditModal(id, editUrl, detalle, title) {
    const form = document.getElementById("form-accion");
    form.action = editUrl.replace("0", id);
    form.reset();
    clearFormErrors();

    fetch(detalle)
      .then((res) => res.json())
      .then((data) => {

        // ================== DETECTAR TIPO DE MODAL ==================
        const isUserModal = document.getElementById("user-available-groups") !== null;
        const isRoleModal = document.getElementById("available-perms") !== null;
        const isClientUserModal = document.getElementById("available-users") !== null;

        console.log("Tipo de modal detectado:", {
          isUserModal: isUserModal,
          isRoleModal: isRoleModal,
          isClientUserModal: isClientUserModal
        });

        if (isUserModal) {
          // ================== LÓGICA PARA USUARIOS ==================

          // GRUPOS
          const userAvailableGroups = document.getElementById("user-available-groups");
          const userSelectedGroups = document.getElementById("user-selected-groups");

          if (userAvailableGroups && userSelectedGroups) {

            // Limpiar ambos contenedores
            userAvailableGroups.innerHTML = "";
            userSelectedGroups.innerHTML = "";

            // Popular select con todos los grupos disponibles
            if (data.all_groups && Array.isArray(data.all_groups)) {
              data.all_groups.forEach(group => {
                // Si el grupo NO está asignado, ponerlo en disponibles
                if (!data.groups.includes(group.id)) {
                  const option = document.createElement("option");
                  option.value = group.id;
                  option.textContent = group.name;
                  userAvailableGroups.appendChild(option);
                } else {
                  // Si el grupo SÍ está asignado, crear checkbox
                  const wrapper = document.createElement("div");
                  wrapper.className = "checkbox-wrapper";
                  wrapper.style.marginBottom = "5px";

                  const label = document.createElement("label");
                  label.style.display = "block";
                  label.innerHTML = `
                    <input type="checkbox" name="groups" value="${group.id}" checked>
                    ${group.name}
                  `;

                  // Agregar evento para devolver al select si se desmarca
                  label.querySelector("input").addEventListener("change", function (e) {
                    if (!e.target.checked) {
                      const opt = document.createElement("option");
                      opt.value = group.id;
                      opt.textContent = group.name;
                      userAvailableGroups.appendChild(opt);
                      wrapper.remove();
                    }
                  });

                  wrapper.appendChild(label);
                  userSelectedGroups.appendChild(wrapper);
                }
              });
            }
          }

          // PERMISOS
          const userAvailablePerms = document.getElementById("user-available-perms");
          const userSelectedPerms = document.getElementById("user-selected-perms");

          if (userAvailablePerms && userSelectedPerms) {

            // Limpiar ambos contenedores
            userAvailablePerms.innerHTML = "";
            userSelectedPerms.innerHTML = "";

            // Popular select con todos los permisos disponibles
            if (data.all_permissions && Array.isArray(data.all_permissions)) {
              data.all_permissions.forEach(permission => {
                // Si el permiso NO está asignado, ponerlo en disponibles
                if (!data.user_permissions.includes(permission.id)) {
                  const option = document.createElement("option");
                  option.value = permission.id;
                  option.textContent = permission.name;
                  userAvailablePerms.appendChild(option);
                } else {
                  // Si el permiso SÍ está asignado, crear checkbox
                  const wrapper = document.createElement("div");
                  wrapper.className = "checkbox-wrapper";
                  wrapper.style.marginBottom = "5px";

                  const label = document.createElement("label");
                  label.style.display = "block";
                  label.innerHTML = `
                    <input type="checkbox" name="user_permissions" value="${permission.id}" checked>
                    ${permission.name}
                  `;

                  // Agregar evento para devolver al select si se desmarca
                  label.querySelector("input").addEventListener("change", function (e) {
                    if (!e.target.checked) {
                      const opt = document.createElement("option");
                      opt.value = permission.id;
                      opt.textContent = permission.name;
                      userAvailablePerms.appendChild(opt);
                      wrapper.remove();
                    }
                  });

                  wrapper.appendChild(label);
                  userSelectedPerms.appendChild(wrapper);
                }
              });
            }
          }

          // Setear el username para usuarios
          const usernameField = form.querySelector('[name="username"]');
          if (usernameField && data.username) {
            usernameField.value = data.username;
          }

        } else if (isRoleModal) {
          // ================== LÓGICA PARA ROLES/PERMISOS EXISTENTE ==================

          const available = document.getElementById("available-perms");
          const selected = document.getElementById("selected-perms");

          if (available && selected) {
            // Tu lógica existente del duallistbox
            const allOptions = [];
            Array.from(available.options).forEach(opt => allOptions.push(opt));
            Array.from(selected.options).forEach(opt => allOptions.push(opt));

            // Vaciar ambos selects
            available.innerHTML = "";
            selected.innerHTML = "";

            // Repartir según permisos asignados
            allOptions.forEach(opt => {
              if (data.permisos && data.permisos.includes(opt.value) || data.permisos_asignados && data.permisos_asignados.includes(parseInt(opt.value))) {
                selected.appendChild(opt);
              } else {
                available.appendChild(opt);
                opt.selected = false;
              }
            });
          }
        }
        else if (isClientUserModal) {
          // ================== LÓGICA PARA USUARIOS/CLIENTES EXISTENTE ==================

          const available = document.getElementById("available-users");
          const selected = document.getElementById("selected-users");

          if (available && selected) {
            // Tu lógica existente del duallistbox
            const allOptions = [];
            Array.from(available.options).forEach(opt => allOptions.push(opt));
            Array.from(selected.options).forEach(opt => allOptions.push(opt));

            // Vaciar ambos selects
            available.innerHTML = "";
            selected.innerHTML = "";

            // Repartir según usuarios asignados
            allOptions.forEach(opt => {
              if (data.usuarios && data.usuarios.includes(opt.value) || data.usuarios_asignados && data.usuarios_asignados.includes(parseInt(opt.value))) {
                selected.appendChild(opt);
              } else {
                available.appendChild(opt);
                opt.selected = false;
              }
            });
          }
        }

        
        // ================== CAMPOS COMUNES ==================
        // Setear otros campos simples (excluyendo los específicos que ya manejamos)
        Object.entries(data).forEach(([key, value]) => {
          // Saltar campos específicos que ya manejamos
          if (key === 'groups' || key === 'user_permissions' || key === 'all_groups' || key === 'all_permissions') return;
          if (key === 'permisos' || key === 'permisos_asignados') return; // Para el duallistbox existente

          const fields = form.querySelectorAll(`[name="${key}"]`);
          if (!fields.length) return;

          fields.forEach((field) => {
            if (field.type === "checkbox") {
              if (Array.isArray(value)) {
                field.checked = value.includes(parseInt(field.value));
              } else {
                field.checked = !!value;
              }
            } else if (field.tagName === "SELECT" && field.multiple) {
              Array.from(field.options).forEach((opt) => {
                opt.selected = (value || []).includes(parseInt(opt.value)) || (value || []).includes(opt.value);
              });
            } else {
              field.value = value;
            }
          });
        });

        // Setear título del modal
        const modalTitle = document.getElementById("modal-title");
        if (modalTitle && data.modal_title) {
          modalTitle.textContent = data.modal_title;
        }
      })
      .catch(error => {
        console.error('Error al cargar datos del usuario:', error);
      });

    // Mostrar modal
    document.getElementById("modal-accion").style.display = "flex";
    const modalTitle = document.getElementById("modal-title");
    modalTitle.textContent = title;
  }
  function openDeleteModal(
    id,
    deleteUrl,
    message
  ) {

    document.getElementById("delete_obj_id").value = id;
    document.getElementById("delete-form").action = deleteUrl.replace("0", id);
    document.getElementById("delete-message").innerText = message || "¿Seguro que deseas realizar esta operacion?";
    document.getElementById("modal-delete").style.display = "flex";
  }


  function closeModal() {
    document.getElementById("modal-accion").style.display = "none";
    document.getElementById("modal-delete").style.display = "none";
  }

  function clearFormErrors() {
    const errorMessages = document.querySelectorAll(".error-messages");
    errorMessages.forEach((error) => error.remove());
  }

  document.querySelectorAll(".btn-edit").forEach((btn) => {

    btn.addEventListener("click", () => {
      openEditModal(btn.dataset.id, btn.dataset.edit, btn.dataset.detalle, btn.dataset.title);
    });


  });

  document.querySelectorAll(".btn-delete").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.id;
      const deleteUrl = btn.dataset.delete;
      openDeleteModal(id, deleteUrl);
      console.log("deleteurl:", deleteUrl)
    });
  });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("form-accion");

    if (form) {
      form.addEventListener("submit", function (e) {
        // Detectar si es un formulario de usuario (tiene los elementos específicos)
        const isUserForm = document.getElementById("user-available-groups") !== null;
      })
      }
})
</script>
