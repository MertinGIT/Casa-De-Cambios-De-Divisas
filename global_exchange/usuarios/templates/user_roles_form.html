{% extends "base_forms.html" %}
{% load widget_tweaks %}
{% block form_title %}
Editar Usuario
{% endblock %}
{% block form_fields %}
{% load static %}

<!-- Nombre del usuario -->
<div class="form-group">
  <label for="username">Usuario</label>
  <div class="input-icon">
    <span class="icon">üë§</span>
    <input type="text" name="username" id="username" class="custom-input" value="{{ usuario.username }}" readonly>
  </div>
</div>

<!-- ================== CONTENEDOR DE COLUMNAS ================== -->
<div class="permissions-container">
  
  <!-- ================== COLUMNA GRUPOS ================== -->
  <div class="column">
    <div class="column-header">
      <h3>Grupos</h3>
    </div>
    
    <!-- Disponibles -->
    <div class="available-section">
      <label>Disponibles</label>
      <select id="user-available-groups" class="custom-select" multiple>
      </select>
    </div>
    
    <!-- Asignados -->
    <div class="assigned-section">
      <label>Asignados</label>
      <div id="user-selected-groups" class="checkbox-container">
      </div>
    </div>
  </div>
  
  <!-- ================== COLUMNA PERMISOS ================== -->
  <div class="column">
    <div class="column-header">
      <h3>Permisos</h3>
    </div>
    
    <!-- Buscador de permisos -->
    <div class="search-section">
      <div class="search-input-wrapper">
        <span class="search-icon">üîç</span>
        <input 
          type="text" 
          id="permission-search" 
          class="search-input" 
          placeholder="Buscar permisos..."
        >
        <button type="button" id="clear-search" class="clear-search" style="display: none;">√ó</button>
      </div>
    </div>
    
    <!-- Disponibles -->
    <div class="available-section">
      <label>Disponibles <span id="perms-count" class="count-badge"></span></label>
      <select id="user-available-perms" class="custom-select" multiple>
      </select>
    </div>
    
    <!-- Asignados -->
    <div class="assigned-section">
      <label>Asignados</label>
      <div id="user-selected-perms" class="checkbox-container">
      </div>
    </div>
  </div>
  
</div>

<style>
  .custom-modal-content {
    max-width: 1200px !important;
  }

  .custom-input {
    width: 100%;
    padding: 8px 12px 8px 36px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background-color: #F0EDFF;
    font-size: 14px;
    outline: none;
  }

  .custom-input::placeholder {
    color: #6b7280;
  }

  .input-icon {
    position: relative;
    margin-bottom: 20px;
  }

  .input-icon .icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    font-size: 16px;
    color: #5D5FEF;
  }

  /* ================== LAYOUT DE COLUMNAS ================== */
  .permissions-container {
    display: flex;
    gap: 24px;
    margin-top: 20px;
  }

  .column {
    flex: 1;
    background: #f8fafc;
    border-radius: 8px;
    padding: 16px;
    border: 1px solid #e2e8f0;
  }

  .column-header {
    margin-bottom: 16px;
    text-align: center;
  }

  .column-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #334155;
    padding-bottom: 8px;
    border-bottom: 2px solid #5D5FEF;
  }

  /* ================== BUSCADOR ================== */
  .search-section {
    margin-bottom: 12px;
  }

  .search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    font-size: 14px;
    color: #64748b;
  }

  .search-input {
    width: 100%;
    padding: 8px 32px 8px 32px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background-color: #ffffff;
    font-size: 13px;
    outline: none;
    transition: all 0.2s;
  }

  .search-input:focus {
    border-color: #5D5FEF;
    box-shadow: 0 0 0 3px rgba(93, 95, 239, 0.1);
  }

  .search-input::placeholder {
    color: #94a3b8;
  }

  .clear-search {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: #e2e8f0;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    color: #64748b;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .clear-search:hover {
    background: #cbd5e1;
    color: #334155;
  }

  .count-badge {
    display: inline-block;
    background: #5D5FEF;
    color: white;
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 4px;
    font-weight: 600;
  }

  /* ================== SECCIONES ================== */
  .available-section, .assigned-section {
    margin-bottom: 16px;
  }

  .available-section label, .assigned-section label {
    display: block;
    font-weight: 600;
    color: #475569;
    margin-bottom: 8px;
    font-size: 14px;
  }

  .custom-select {
    width: 100%;
    min-height: 120px;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background-color: #ffffff;
    font-size: 13px;
    outline: none;
    resize: vertical;
  }

  .custom-select:focus {
    border-color: #5D5FEF;
    box-shadow: 0 0 0 3px rgba(93, 95, 239, 0.1);
  }

  .custom-select option {
    padding: 4px 8px;
    cursor: pointer;
  }

  .custom-select option:hover {
    background-color: #f0f0ff;
  }

  .custom-select option[style*="display: none"] {
    display: none !important;
  }

  /* ================== CONTENEDOR DE CHECKBOXES ================== */
  .checkbox-container {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: #ffffff;
    padding: 8px;
  }

  .checkbox-wrapper {
    margin-bottom: 4px;
    padding: 4px;
    border-radius: 4px;
    transition: background-color 0.2s;
  }

  .checkbox-wrapper:hover {
    background-color: #f8fafc;
  }

  /* ================== CHECKBOXES PERSONALIZADOS ================== */
  .checkbox-wrapper label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 13px;
    color: #374151;
    margin: 0;
    padding: 4px;
    user-select: none;
  }

  /* Ocultar checkbox nativo */
  .checkbox-wrapper input[type="checkbox"] {
    opacity: 0;
    position: absolute;
    width: 0;
    height: 0;
  }

  /* Checkbox personalizado */
  .checkbox-wrapper label::before {
    content: '';
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #d1d5db;
    border-radius: 3px;
    background-color: #ffffff;
    margin-right: 8px;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  /* Estado hover */
  .checkbox-wrapper label:hover::before {
    border-color: #5D5FEF;
  }

  /* Estado checked */
  .checkbox-wrapper input[type="checkbox"]:checked + label::before,
  .checkbox-wrapper label:has(input[type="checkbox"]:checked)::before {
    background-color: #5D5FEF;
    border-color: #5D5FEF;
  }

  /* Checkmark */
  .checkbox-wrapper input[type="checkbox"]:checked + label::after,
  .checkbox-wrapper label:has(input[type="checkbox"]:checked)::after {
    content: '‚úì';
    position: absolute;
    color: white;
    font-size: 12px;
    font-weight: bold;
    margin-left: -14px;
    margin-top: -1px;
  }

  /* Estilos responsivos */
  @media (max-width: 768px) {
    .permissions-container {
      flex-direction: column;
      gap: 16px;
    }
    
    .custom-modal-content {
      max-width: 95% !important;
      margin: 10px;
    }
  }

  /* Scrollbar personalizado para los containers */
  .checkbox-container::-webkit-scrollbar {
    width: 6px;
  }

  .checkbox-container::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
  }

  .checkbox-container::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }

  .checkbox-container::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
</style>

<script>
  // ================== FUNCIONES GLOBALES PARA EL BUSCADOR ==================
  window.updatePermissionCount = function() {
    const availablePerms = document.getElementById("user-available-perms");
    const permsCountBadge = document.getElementById("perms-count");
    const searchInput = document.getElementById("permission-search");
    
    if (availablePerms && permsCountBadge) {
      const visibleOptions = Array.from(availablePerms.options).filter(opt => opt.style.display !== 'none');
      const total = availablePerms.options.length;
      const visible = visibleOptions.length;
      
      if (searchInput && searchInput.value.trim()) {
        permsCountBadge.textContent = `${visible}/${total}`;
      } else {
        permsCountBadge.textContent = `${total}`;
      }
    }
  };

  window.filterPermissions = function() {
    const availablePerms = document.getElementById("user-available-perms");
    const searchInput = document.getElementById("permission-search");
    const clearSearchBtn = document.getElementById("clear-search");
    
    if (!availablePerms || !searchInput) return;
    
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    Array.from(availablePerms.options).forEach(option => {
      const text = option.textContent.toLowerCase();
      if (text.includes(searchTerm)) {
        option.style.display = '';
      } else {
        option.style.display = 'none';
      }
    });
    
    window.updatePermissionCount();
    
    // Mostrar/ocultar bot√≥n de limpiar
    if (clearSearchBtn) {
      if (searchTerm) {
        clearSearchBtn.style.display = 'flex';
      } else {
        clearSearchBtn.style.display = 'none';
      }
    }
  };

  window.clearPermissionSearch = function() {
    const searchInput = document.getElementById("permission-search");
    const clearSearchBtn = document.getElementById("clear-search");
    
    if (searchInput) {
      searchInput.value = "";
      window.filterPermissions();
      searchInput.focus();
    }
  };

  // ================== INICIALIZACI√ìN AL CARGAR EL DOM ==================
  document.addEventListener("DOMContentLoaded", function () {
    
    // Funci√≥n auxiliar para mover elementos al contenedor de seleccionados
    function moveToSelected(container, option, inputName, selectId) {
      const value = option.value;
      const text = option.textContent;

      // Crear wrapper div para el checkbox
      const wrapper = document.createElement("div");
      wrapper.className = "checkbox-wrapper";

      const label = document.createElement("label");
      label.innerHTML = `
        <input type="checkbox" name="${inputName}" value="${value}" checked>
        <span>${text}</span>
      `;

      label.querySelector("input").addEventListener("change", function (e) {
        if (!e.target.checked) {
          // Si se desmarca ‚Üí devolver al select correspondiente
          const opt = document.createElement("option");
          opt.value = value;
          opt.textContent = text;
          selectId.appendChild(opt);
          wrapper.remove();
          
          // Actualizar contador y aplicar filtro de b√∫squeda
          if (selectId.id === "user-available-perms") {
            window.updatePermissionCount();
            window.filterPermissions();
          }
        }
      });

      wrapper.appendChild(label);
      container.appendChild(wrapper);
      option.remove();
      
      // Actualizar contador si es de permisos
      if (selectId.id === "user-available-perms") {
        window.updatePermissionCount();
      }
    }

    // ================== CONFIGURACI√ìN DE GRUPOS ==================
    const availableGroups = document.getElementById("user-available-groups");
    const selectedGroups = document.getElementById("user-selected-groups");

    if (availableGroups && selectedGroups) {
      availableGroups.addEventListener("click", function (e) {
        if (e.target.tagName === "OPTION") {
          moveToSelected(selectedGroups, e.target, "groups", availableGroups);
        }
      });
    }

    // ================== CONFIGURACI√ìN DE PERMISOS CON BUSCADOR ==================
    const availablePerms = document.getElementById("user-available-perms");
    const selectedPerms = document.getElementById("user-selected-perms");
    const searchInput = document.getElementById("permission-search");
    const clearSearchBtn = document.getElementById("clear-search");

    if (availablePerms && selectedPerms && searchInput) {
      // Click para mover permisos
      availablePerms.addEventListener("click", function (e) {
        if (e.target.tagName === "OPTION") {
          moveToSelected(selectedPerms, e.target, "user_permissions", availablePerms);
        }
      });

      // Evento de b√∫squeda
      searchInput.addEventListener("input", window.filterPermissions);

      // Bot√≥n de limpiar b√∫squeda
      if (clearSearchBtn) {
        clearSearchBtn.addEventListener("click", window.clearPermissionSearch);
      }

      // Inicializar contador
      window.updatePermissionCount();
    }
  });
</script>
{% endblock %}