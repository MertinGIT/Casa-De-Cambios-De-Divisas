{% extends "base_forms.html" %} 

{% load widget_tweaks %} 

{% block form_title %}Agregar Metodo de Pago{% endblock %} 

{% block form_fields %}

<div class="form-group">
  <label for="{{ form.nombre.id_for_label }}">Nombre *</label>
  <div class="input-icon">
    <span class="icon">💳</span>
    {{ form.nombre|add_class:"custom-input" }}
  </div>
  <div class="error-messages">
    {% if form.nombre.errors %}
      {% for error in form.nombre.errors %}
        <div class="error-message">{{ error }}</div>
      {% endfor %}
    {% endif %}
  </div>
</div>

<div class="form-group">
  <label for="{{ form.descripcion.id_for_label }}">Descripcion</label>
  <div class="input-icon">
    <span class="icon">📝</span>
    {{ form.descripcion|add_class:"custom-input" }}
  </div>
  <div class="error-messages">
    {% if form.descripcion.errors %}
      {% for error in form.descripcion.errors %}
        <div class="error-message">{{ error }}</div>
      {% endfor %}
    {% endif %}
  </div>
</div>

<style>
.custom-input {
  width: 100%;
  padding: 8px 12px 8px 36px; /* espacio para icono */
  border-radius: 6px;
  border: 1px solid #d1d5db;
  background-color: #f0edff;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.custom-input::placeholder {
  color: #6b7280;
}

.custom-input:focus {
  border-color: #5d5fef;
  box-shadow: 0 0 0 3px rgba(93, 95, 239, 0.1);
}

/* Estilos para validación */
.custom-input.error {
  border-color: #ef4444 !important;
  background-color: #fef2f2;
}

.custom-input.valid {
  border-color: #10b981;
  background-color: #f0fdf4;
}

.input-icon {
  position: relative;
  margin-bottom: 4px;
}

.input-icon .icon {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  font-size: 16px;
  color: #5d5fef;
  z-index: 1;
}

.error-messages {
  min-height: 18px;
  margin-bottom: 8px;
  display: block;
}

.error-messages .error-message {
  color: #ef4444 !important;
  font-size: 12px !important;
  font-weight: normal !important;
  margin: 2px 0 !important;
  padding: 0 !important;
  display: block !important;
  background: none !important;
  border: none !important;
  text-align: left !important;
  line-height: 1.4 !important;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Marcar campos con errores del servidor */
{% if form.nombre.errors %}
#id_nombre {
  border-color: #ef4444 !important;
  background-color: #fef2f2;
}
{% endif %}

{% if form.descripcion.errors %}
#id_descripcion {
  border-color: #ef4444 !important;
  background-color: #fef2f2;
}
{% endif %}
</style>

<!-- jQuery Validate Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<script>
// Variable global para el validador
let MetodoPagoValidator = null;

// Configurar mensajes en español
jQuery.extend(jQuery.validator.messages, {
    required: "Este campo es obligatorio.",
    minlength: jQuery.validator.format("Por favor, no escribas menos de {0} caracteres."),
    maxlength: jQuery.validator.format("Por favor, no escribas más de {0} caracteres."),
    remote: "Este nombre ya existe, por favor elige otro."
});

// Función para inicializar validación
function setupMetodoPagoValidation() {
    const $form = $("#form-accion");
    
    if (!$form.length) {
        console.log("Formulario no encontrado");
        return null;
    }

    // Destruir validador existente si existe
    if (MetodoPagoValidator) {
        MetodoPagoValidator.destroy();
        MetodoPagoValidator = null;
    }

    console.log("Configurando validación del formulario metodo de pago");
    
    // Obtener ID actual para edición
    const currentId = $("#obj_id").val() || null;
    
    MetodoPagoValidator = $form.validate({
        rules: {
            nombre: {
                required: true,
                minlength: 3,
                maxlength: 100,
                remote: {
                    url: "{% url 'metodos-pagos-validar-nombre' %}",
                    type: "POST",
                    data: {
                        nombre: function() {
                            return $("#id_nombre").val();
                        },
                        current_id: function() {
                            return $("#obj_id").val() || '';
                        },
                        csrfmiddlewaretoken: function() {
                            return $('[name=csrfmiddlewaretoken]').val();
                        }
                    },
                    dataFilter: function(data) {
                        var json = JSON.parse(data);
                        return json.valid ? "true" : "false";
                    }
                }
            },
            descripcion: {
                required: false,
                maxlength: 500
            }
        },
        messages: {
            nombre: {
                required: "El nombre es obligatorio",
                minlength: "El nombre debe tener al menos 3 caracteres",
                maxlength: "El nombre no puede exceder 100 caracteres",
                remote: "Este nombre ya existe, por favor elige otro"
            },
            descripcion: {
                maxlength: "La descripción no puede exceder 500 caracteres"
            }
        },
        errorElement: 'div',
        errorClass: 'error-message',
        validClass: 'valid',
        errorPlacement: function(error, element) {
            console.log("Colocando error:", error.text(), "para elemento:", element.attr('name'));
            let formGroup = element.closest('.form-group');
            let errorContainer = formGroup.find('.error-messages');
            
            if (!errorContainer.length) {
                errorContainer = $('<div class="error-messages"></div>').appendTo(formGroup);
            }
            
            // Limpiar errores del servidor al mostrar errores de jQuery Validate
            errorContainer.find('.error-message').remove();
            errorContainer.append(error);
        },
        highlight: function(element, errorClass, validClass) {
            $(element).addClass('error').removeClass(validClass);
            console.log("Marcando campo con error:", $(element).attr('name'));
        },
        unhighlight: function(element, errorClass, validClass) {
            $(element).removeClass('error').addClass(validClass);
            console.log("Limpiando error de campo:", $(element).attr('name'));
        },
        success: function(label, element) {
            console.log("Campo válido:", $(element).attr('name'));
            $(element).closest('.form-group').find('.error-messages').empty();
        },
        submitHandler: function(form) {
            console.log("Formulario válido, enviando...");
            form.submit();
        },
        invalidHandler: function(event, validator) {
            console.log("Formulario inválido, errores:", validator.numberOfInvalids());
        }
    });

    return MetodoPagoValidator;
}

// Sobrescribir funciones del modal para incluir validación
$(document).ready(function() {
    // Guardar funciones originales
    const originalOpenCreateModal = window.openCreateModal;
    const originalOpenEditModal = window.openEditModal;
    const originalCloseModal = window.closeModal;

    // Nueva función para crear modal
    window.openCreateModal = function(createUrl) {
        console.log("Abriendo modal crear con validación");
        
        if (originalOpenCreateModal) {
            originalOpenCreateModal(createUrl);
        }
        
        // Configurar validación después de que el modal se abra
        setTimeout(function() {
            setupMetodoPagoValidation();
        }, 200);
    };

    // Nueva función para editar modal
    window.openEditModal = function(id, editUrl, detalle) {
        console.log("Abriendo modal editar con validación, ID:", id);
        
        if (originalOpenEditModal) {
            originalOpenEditModal(id, editUrl, detalle);
        }
        
        // Configurar validación después de cargar datos
        setTimeout(function() {
            // Asegurar que el campo obj_id tenga el ID correcto
            const objIdField = $("#obj_id");
            if (objIdField.length) {
                objIdField.val(id);
                console.log("Campo obj_id actualizado con valor:", id);
            }
            
            setupMetodoPagoValidation();
        }, 1000); // Timeout más largo para que el fetch termine
    };

    // Nueva función para cerrar modal
    window.closeModal = function() {
        console.log("Cerrando modal y limpiando validación");
        
        // Limpiar validación
        if (MetodoPagoValidator) {
            MetodoPagoValidator.destroy();
            MetodoPagoValidator = null;
        }
        
        // Limpiar clases y mensajes manualmente
        $("#form-accion .error").removeClass('error');
        $("#form-accion .valid").removeClass('valid');
        $(".error-messages").empty();
        
        if (originalCloseModal) {
            originalCloseModal();
        }
    };

    console.log("Sistema de validación de metodo de pago inicializado");
});
</script>

{% endblock %}