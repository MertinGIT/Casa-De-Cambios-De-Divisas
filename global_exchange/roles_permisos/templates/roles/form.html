{% extends "base_forms.html" %}
{% load widget_tweaks %}
{% block form_title %}Agregar Rol{% endblock %}
{% block form_fields %}
<!-- Nombre del rol -->
<div class="form-group">
  <label for="{{ form.name.id_for_label }}">Nombre</label>
  <div class="input-icon">
    <span class="icon">üë§</span>
    {{ form.name|add_class:"custom-input" }}
  </div>
  {% if form.name.errors %}
  <div class="error-messages">
    {% for error in form.name.errors %}
    <span class="error-text">{{ error }}</span>
    {% endfor %}
  </div>
  {% endif %}
</div>

<!-- Dual listbox de permisos -->
<div class="form-group">
  <div class="dual-listbox">
    <div class="dual-listbox-content">
      <div>
        <h5>Permisos disponibles</h5>
        <select id="available-perms" multiple size="15">
          {% for permiso in permisos %}
          <option value="{{ permiso.id }}">{{ permiso.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="dual-buttons">
        <button type="button" id="add-perm" class="btn btn-primary">‚Üí</button>
        <button type="button" id="remove-perm" class="btn btn-secondary">‚Üê</button>
      </div>

      <div>
        <h5>Permisos asignados</h5>
        <!-- name="permisos" es el que Django espera en POST (coincide con el field 'permisos') -->
        <select id="selected-perms" name="permisos" multiple size="15">
          {% for permiso in permisos %}
          {% if permiso.id in permisos_asignados %}
          <option value="{{ permiso.id }}" selected>{{ permiso.name }}</option>
          {% endif %}
          {% endfor %}
        </select>
      </div>
    </div>
  </div>
  <style>
    .custom-modal-content {
      max-width: 900px !important;
    }

    .custom-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background-color: #F0EDFF;
      font-size: 14px;
      outline: none;
    }

    .custom-input::placeholder {
      color: #6b7280;
    }

    .input-icon {
      position: relative;
    }

    .input-icon .icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      font-size: 16px;
      color: #5D5FEF;
    }

    /* Dual listbox */
    .dual-listbox {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .dual-listbox select {
      width: 220px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      padding: 5px;
      font-size: 14px;
    }

    .dual-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .dual-buttons button {
      width: 50px;
    }

    .dual-listbox-content {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }
  </style>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const addBtn = document.getElementById("add-perm");
      const removeBtn = document.getElementById("remove-perm");
      const available = document.getElementById("available-perms");
      const selected = document.getElementById("selected-perms");
      addBtn.addEventListener("click", () => moveOptions(available, selected));
      removeBtn.addEventListener("click", () => moveOptions(selected, available));
      function moveOptions(from, to) {
        Array.from(from.selectedOptions).forEach(opt => {
          to.add(opt);
          opt.selected = to === selected;
        });
      }
      // Asegura que todos los seleccionados se env√≠en al hacer submit
      selected.closest("form").addEventListener("submit", () => {
        Array.from(selected.options).forEach(opt => opt.selected = true);
      });
    });
  </script>
  {% endblock %}