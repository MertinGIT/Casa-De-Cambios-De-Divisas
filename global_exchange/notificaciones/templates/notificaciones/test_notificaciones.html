<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Notificaciones</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { color: #1e2d70; }
        .btn {
            background: linear-gradient(135deg, #5d5fef, #4a4cd9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.info { background: #dbeafe; color: #1e40af; }
        .log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .log-entry:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="panel">
        <h1>üß™ Panel de Pruebas de Notificaciones</h1>
        
        <div id="status" class="status info">
            üîÑ Esperando conexi√≥n...
        </div>

        <div style="margin: 20px 0;">
            <h3>Acciones de Prueba:</h3>
            <button class="btn" onclick="enviarNotificacionPrueba('USD', 1.5, true)">
                üìà Simular USD Subi√≥ 1.5%
            </button>
            <button class="btn" onclick="enviarNotificacionPrueba('EUR', -2.3, false)">
                üìâ Simular EUR Baj√≥ 2.3%
            </button>
            <button class="btn" onclick="enviarNotificacionPrueba('BRL', 5.7, true)">
                üìà Simular BRL Subi√≥ 5.7%
            </button>
            <button class="btn" onclick="limpiarLog()">üóëÔ∏è Limpiar Log</button>
        </div>

        <div class="log" id="log">
            <div class="log-entry">üìù Log de eventos...</div>
        </div>
    </div>

    <script>
        let ws = null;
        const logEl = document.getElementById('log');
        const statusEl = document.getElementById('status');

        function addLog(msg, type = 'info') {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            entry.innerHTML = `[${time}] ${icon} ${msg}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateStatus(msg, type) {
            statusEl.textContent = msg;
            statusEl.className = `status ${type}`;
        }

        function conectarWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/notificaciones/`;
            
            addLog(`Conectando a ${wsUrl}`);
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    addLog('WebSocket conectado correctamente', 'success');
                    updateStatus('üü¢ Conectado - Listo para recibir notificaciones', 'success');
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    addLog(`Mensaje recibido: ${JSON.stringify(data)}`, 'success');
                    
                    if (data.type === 'notificar_cambio_tasa') {
                        mostrarNotificacion(data);
                    }
                };
                
                ws.onerror = (error) => {
                    addLog(`Error en WebSocket: ${error}`, 'error');
                    updateStatus('üî¥ Error de conexi√≥n', 'error');
                };
                
                ws.onclose = () => {
                    addLog('WebSocket desconectado', 'error');
                    updateStatus('üü° Desconectado - Reintentando...', 'error');
                    setTimeout(conectarWebSocket, 3000);
                };
            } catch (error) {
                addLog(`Error al crear WebSocket: ${error}`, 'error');
                updateStatus('üî¥ Error de conexi√≥n', 'error');
            }
        }

        function enviarNotificacionPrueba(moneda, porcentaje, subio) {
            addLog(`Solicitando notificaci√≥n de prueba para ${moneda}`);
            
            // Simular recepci√≥n de notificaci√≥n
            const precioAnterior = 7000;
            const precioNuevo = subio ? 
                precioAnterior * (1 + porcentaje/100) : 
                precioAnterior * (1 - Math.abs(porcentaje)/100);
            
            const data = {
                type: 'notificar_cambio_tasa',
                moneda: moneda,
                precio_anterior: precioAnterior,
                precio_nuevo: precioNuevo,
                porcentaje_cambio: porcentaje
            };
            
            mostrarNotificacion(data);
            addLog(`Notificaci√≥n simulada: ${moneda} ${subio ? '‚Üë' : '‚Üì'} ${Math.abs(porcentaje)}%`, 'success');
        }

        function mostrarNotificacion(data) {
            const { moneda, precio_anterior, precio_nuevo, porcentaje_cambio } = data;
            const subio = precio_nuevo > precio_anterior;
            
            // Crear notificaci√≥n visual
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                border: 2px solid ${subio ? '#16a34a' : '#dc2626'};
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                z-index: 9999;
                min-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notif.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 2rem;">${subio ? 'üìà' : 'üìâ'}</span>
                    <strong style="font-size: 1.2rem; color: #1e2d70;">${moneda}</strong>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="ml-auto; border: none; background: none; font-size: 1.5rem; cursor: pointer;">
                        √ó
                    </button>
                </div>
                <p style="margin: 10px 0; color: #666;">
                    ¬°Cambio de tasa detectado! (${porcentaje_cambio.toFixed(2)}%)
                </p>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                    <div style="margin: 5px 0;">
                        <strong>Anterior:</strong> ${precio_anterior.toFixed(2)}
                    </div>
                    <div style="margin: 5px 0;">
                        <strong>Nuevo:</strong> ${precio_nuevo.toFixed(2)}
                    </div>
                </div>
            `;
            
            document.body.appendChild(notif);
            
            // Auto cerrar despu√©s de 10 segundos
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notif.remove(), 300);
            }, 10000);
        }

        function limpiarLog() {
            logEl.innerHTML = '<div class="log-entry">üìù Log limpiado</div>';
        }

        // Conectar al cargar
        document.addEventListener('DOMContentLoaded', conectarWebSocket);
    </script>

    <style>
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</body>
</html>